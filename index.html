<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver-adz - ระบบวางแผนเส้นทาง</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc62fmzeQ1I2ACl8f926bum8CY25TdESM&libraries=places,geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.5;
        }
        
        #map {
            width: 100%;
            height: 400px;
            background-color: #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-3xl { border-radius: 1.5rem; }
        .rounded-full { border-radius: 9999px; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .transition-all { transition: all 0.3s ease; }
        .transform { transform: translateZ(0); }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .hover\:shadow-xl:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Layout */
        .min-h-screen { min-height: 100vh; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .flex-1 { flex: 1; }
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-3xl { max-width: 48rem; }
        
        /* Spacing */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .px-8 { padding-left: 2rem; padding-right: 2rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-3 { margin-right: 0.75rem; }
        
        /* Colors */
        .bg-white { background-color: #ffffff; }
        .bg-black { background-color: #000000; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-900 { background-color: #111827; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-yellow-50 { background-color: #fefce8; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-orange-50 { background-color: #fff7ed; }
        .bg-orange-100 { background-color: #fed7aa; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .bg-indigo-50 { background-color: #eef2ff; }
        .bg-red-500 { background-color: #ef4444; }
        .text-white { color: #ffffff; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-green-600 { color: #16a34a; }
        .text-green-700 { color: #15803d; }
        .text-yellow-700 { color: #a16207; }
        .text-orange-600 { color: #ea580c; }
        .text-purple-600 { color: #9333ea; }
        .text-purple-700 { color: #6b21a1; }
        .text-red-600 { color: #dc2626; }
        
        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-medium { font-weight: 500; }
        .font-bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* Borders */
        .border { border: 1px solid; }
        .border-2 { border: 2px solid; }
        .border-3 { border: 3px solid; }
        .border-t { border-top: 1px solid; }
        .border-b { border-bottom: 1px solid; }
        .border-b-2 { border-bottom: 2px solid; }
        .border-gray-100 { border-color: #f3f4f6; }
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-gray-900 { border-color: #111827; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-blue-400 { border-color: #60a5fa; }
        .border-green-200 { border-color: #bbf7d0; }
        .border-green-400 { border-color: #4ade80; }
        .border-purple-200 { border-color: #e9d5ff; }
        .border-purple-300 { border-color: #d8b4fe; }
        .border-purple-500 { border-color: #a855f7; }
        .border-red-200 { border-color: #fecaca; }
        .border-transparent { border-color: transparent; }
        .divide-y > * + * { border-top: 1px solid #e5e7eb; }
        
        /* Gradients */
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--gradient-from), var(--gradient-to)); }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--gradient-from), var(--gradient-to)); }
        .from-gray-50 { --gradient-from: #f9fafb; }
        .from-gray-500 { --gradient-from: #6b7280; }
        .from-gray-700 { --gradient-from: #374151; }
        .from-gray-900 { --gradient-from: #111827; }
        .from-blue-50 { --gradient-from: #eff6ff; }
        .from-blue-500 { --gradient-from: #3b82f6; }
        .from-green-50 { --gradient-from: #f0fdf4; }
        .from-green-500 { --gradient-from: #10b981; }
        .from-yellow-50 { --gradient-from: #fefce8; }
        .from-yellow-500 { --gradient-from: #eab308; }
        .from-orange-50 { --gradient-from: #fff7ed; }
        .from-orange-500 { --gradient-from: #f97316; }
        .from-purple-50 { --gradient-from: #faf5ff; }
        .from-purple-500 { --gradient-from: #a855f7; }
        .from-indigo-50 { --gradient-from: #eef2ff; }
        .from-red-50 { --gradient-from: #fef2f2; }
        .from-teal-500 { --gradient-from: #14b8a6; }
        .from-white { --gradient-from: #ffffff; }
        .to-gray-100 { --gradient-to: #f3f4f6; }
        .to-gray-600 { --gradient-to: #4b5563; }
        .to-gray-900 { --gradient-to: #111827; }
        .to-black { --gradient-to: #000000; }
        .to-cyan-50 { --gradient-to: #ecfeff; }
        .to-cyan-500 { --gradient-to: #06b6d4; }
        .to-cyan-600 { --gradient-to: #0891b2; }
        .to-blue-100 { --gradient-to: #dbeafe; }
        .to-blue-600 { --gradient-to: #2563eb; }
        .to-green-100 { --gradient-to: #dcfce7; }
        .to-emerald-50 { --gradient-to: #ecfdf5; }
        .to-emerald-500 { --gradient-to: #10b981; }
        .to-emerald-600 { --gradient-to: #059669; }
        .to-yellow-100 { --gradient-to: #fef3c7; }
        .to-orange-100 { --gradient-to: #fed7aa; }
        .to-red-500 { --gradient-to: #ef4444; }
        .to-pink-50 { --gradient-to: #fdf2f8; }
        .to-pink-500 { --gradient-to: #ec4899; }
        .to-purple-100 { --gradient-to: #f3e8ff; }
        .to-purple-600 { --gradient-to: #9333ea; }
        .to-indigo-100 { --gradient-to: #e0e7ff; }
        .to-indigo-500 { --gradient-to: #6366f1; }
        
        /* Custom Styles */
        header {
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #e5e7eb;
        }
        
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0.25rem;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.3s;
            cursor: pointer;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        
        .nav-tab:hover {
            color: #374151;
            border-bottom-color: #d1d5db;
        }
        
        .nav-tab.active {
            color: #20B2AA;
            border-bottom-color: #20B2AA;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #20B2AA, #48D1CC);
            color: white;
        }
        
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s;
            outline: none;
        }
        
        .input:focus {
            border-color: #029D84;
            box-shadow: 0 0 0 3px rgba(32, 178, 170, 0.1);
        }
        
        .select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s;
            outline: none;
            background-color: white;
            cursor: pointer;
        }
        
        .select:focus {
            border-color: #029D84;
            box-shadow: 0 0 0 3px rgba(32, 178, 170, 0.1);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-size: 0.7rem;
            font-weight: 500;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: linear-gradient(to right, #f9fafb, #f3f4f6);
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .table td {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .table tr:hover {
            background-color: #f9fafb;
        }
        
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 2px solid #f3f4f6;
            padding: 1.25rem;
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        .modal {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 32rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fade-in 0.3s ease-out;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }
        
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .badge-green {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
        }
        
        .icon-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .icon-lg {
            width: 2rem;
            height: 2rem;
        }
        
        .icon-xl {
            width: 3rem;
            height: 3rem;
        }
        
        /* Trip Card Specific Styles */
        .trip-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid #f3f4f6;
            padding: 1rem;
            transition: all 0.3s;
            cursor: move;
        }
        
        .trip-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .trip-card.dragging {
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        
        .trip-card.drop-target {
            border-color: #4ade80;
            background-color: #f0fdf4;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .trip-card.selected-target {
            border-color: #a855f7;
            background-color: #faf5ff;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(1.05);
        }
        
        .branch-item {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
            cursor: move;
            font-size: 0.75rem;
        }
        
        .branch-item:hover {
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }
        
        .branch-item.dragging {
            opacity: 0.5;
            border-color: #60a5fa;
            background-color: #eff6ff;
        }
        
        .branch-item.selected {
            border-color: #a855f7;
            background-color: #f3e8ff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Trip stats grid smaller */
        .trip-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .trip-stat {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
        }
        
        .trip-stat-value {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .trip-stat-label {
            font-size: 0.625rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
        
        /* Branch list scrollable */
        .branch-list-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.75rem;
            padding-right: 0.25rem;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #20B2AA;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification Styles */
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            display: block;
            height: 0.5rem;
            width: 0.5rem;
            border-radius: 9999px;
            background-color: #ef4444;
            ring: 2px solid white;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .map-control-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .map-control-btn:hover {
            background: #f9fafb;
            border-color: #20B2AA;
        }
        
        .map-control-btn.active {
            background: #20B2AA;
            color: white;
            border-color: #20B2AA;
        }
        
        /* Trip Filter */
       .trip-filter {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border-radius: 0.75rem;
        padding: 0.75rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 999;
        max-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid rgba(32, 178, 170, 0.2);
       }
        
        .trip-filter h5 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        
        .trip-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .trip-checkbox input {
            cursor: pointer;
        }
        
        .trip-checkbox label {
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .trip-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        /* Driver Search Dropdown */
        .driver-search-container {
            position: relative;
        }
        
        .driver-search-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            outline: none;
        }
        
        .driver-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .driver-search-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .driver-search-item:hover {
            background-color: #f3f4f6;
        }
        
        .driver-search-item.selected {
            background-color: #20B2AA;
            color: white;
        }
        
        /* Responsive Grid */
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }
        /* Move Branch Modal Styles */
.trip-option {
    transition: all 0.3s ease;
}

.trip-option:hover {
    transform: translateX(4px);
}

#moveBranchModal .modal {
    max-height: 90vh;
    overflow-y: auto;
}

#tripOptionsList::-webkit-scrollbar {
    width: 6px;
}

#tripOptionsList::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}
/* Move Branch Modal - Clickable Cards */
.trip-option-card {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: white;
}

.trip-option-card:hover {
    border-color: #20B2AA;
    background: #f0fdfa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(32, 178, 170, 0.15);
}

.trip-option-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.trip-option-card.disabled:hover {
    border-color: #e5e7eb;
    background: white;
    transform: none;
    box-shadow: none;
}

.trip-option-card::after {
    content: 'คลิกเพื่อเลือก';
    position: absolute;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    background: #20B2AA;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.trip-option-card:hover::after {
    opacity: 1;
}

.trip-option-card.disabled::after {
    display: none;
}


        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Success Modal Styles */
.success-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease-out;
    padding: 1rem;
}

.success-modal {
    background: white;
    border-radius: 24px;
    padding: 3rem 2.5rem 2.5rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
    position: relative;
    overflow: visible;
    animation: slideUp 0.4s ease-out;
}

/* ปุ่มปิด X */
.success-close-btn {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: #f5f5f5;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: #666;
}

.success-close-btn:hover {
    background: #e8e8e8;
    transform: scale(1.05);
}

/* ไอคอนหลัก */
.success-icon-wrapper {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 0 auto 2rem;
}

.success-icon {
    position: relative;
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    animation: scaleIn 0.5s ease-out 0.2s both;
    box-shadow: 0 8px 24px rgba(32, 178, 170, 0.4);
}

.success-icon-bg {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.2;
    animation: pulse 2s ease-in-out infinite;
}

/* หัวข้อ */
.success-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a1a1a;
    text-align: center;
    margin-bottom: 0.5rem;
    animation: fadeInUp 0.5s ease-out 0.3s both;
}

.success-subtitle {
    font-size: 1rem;
    color: #666;
    text-align: center;
    margin-bottom: 2.5rem;
    animation: fadeInUp 0.5s ease-out 0.4s both;
}

/* สถิติ */
.success-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2.5rem;
}

.stat-card {
    background: #f8f9fa;
    border-radius: 16px;
    padding: 1.5rem 1rem;
    text-align: center;
    transition: all 0.3s ease;
    animation: fadeInUp 0.5s ease-out 0.5s both;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    display: block;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #20B2AA;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #666;
}

/* ปุ่มดำเนินการ */
.success-actions {
    display: flex;
    gap: 1rem;
    animation: fadeInUp 0.5s ease-out 0.6s both;
}

.success-btn-primary {
    flex: 1;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #20B2AA 0%, #48D1CC 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 14px rgba(32, 178, 170, 0.4);
}

.success-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(32, 178, 170, 0.5);
}

.success-btn-secondary {
    padding: 1rem 2rem;
    background: #f5f5f5;
    color: #666;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.success-btn-secondary:hover {
    background: #e8e8e8;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes scaleIn {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: translate(-50%, -50%) scale(1);
    }
    50% {
        transform: translate(-50%, -50%) scale(1.2);
    }
}

/* Responsive */
@media (max-width: 640px) {
    .success-modal {
        padding: 2rem 1.5rem;
    }
    
    .success-stats {
        gap: 0.75rem;
    }
    
    .stat-card {
        padding: 1rem 0.5rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .success-actions {
        flex-direction: column;
    }
}
        
        /* Map Popup Styles - Modern Design */
.map-popup {
    position: fixed;  /* เปลี่ยนจาก absolute เป็น fixed */
    top: 50%;         /* ตั้งไว้กลางแนวตั้ง */
    left: 50%;        /* ตั้งไว้กลางแนวนอน */
    transform: translate(-50%, -50%); /* จัดให้อยู่กลางพอดี */
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: 
        0 25px 50px rgba(0,0,0,0.3),
        0 0 0 1px rgba(32, 178, 170, 0.3),
        inset 0 0 30px rgba(32, 178, 170, 0.05);
    padding: 1.5rem;
    min-width: 320px;
    max-width: 400px;
    max-height: 80vh;  /* จำกัดความสูงไม่เกิน 80% ของหน้าจอ */
    z-index: 10000;
    animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 2px solid rgba(32, 178, 170, 0.4);
    overflow: hidden;
}
/* พื้นหลังมืดเมื่อเปิด Popup */
.map-popup-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 9999;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
      
.map-popup::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
        transparent 30%, 
        rgba(32, 178, 170, 0.1) 50%, 
        transparent 70%);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@keyframes popIn {
    0% {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.map-popup-header {
    font-weight: 700;
    font-size: 1.25rem;
    color: #1f2937;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
    position: relative;
    z-index: 1;
}

.map-popup-search {
    position: relative;
    margin-bottom: 1rem;
    z-index: 1;
}

.map-popup-search input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.875rem;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.9);
}

.map-popup-search input:focus {
    outline: none;
    border-color: #20B2AA;
    box-shadow: 0 0 0 4px rgba(32, 178, 170, 0.1);
    transform: translateY(-1px);
}

.map-popup-search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    pointer-events: none;
}

.map-popup-trips {
    max-height: 300px;
    overflow-y: auto;
    position: relative;
    z-index: 1;
    padding-right: 0.5rem;
}

.map-popup-trips::-webkit-scrollbar {
    width: 6px;
}

.map-popup-trips::-webkit-scrollbar-thumb {
    background: rgba(32, 178, 170, 0.3);
    border-radius: 3px;
}

.map-popup-trips::-webkit-scrollbar-thumb:hover {
    background: rgba(32, 178, 170, 0.5);
}

.map-popup-trip-item {
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid #e5e7eb;
    background: rgba(255, 255, 255, 0.8);
    position: relative;
    overflow: hidden;
}

.map-popup-trip-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(32, 178, 170, 0.1), 
        transparent);
    transition: width 0.3s;
}

.map-popup-trip-item:hover {
    background: rgba(32, 178, 170, 0.05);
    border-color: #20B2AA;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(32, 178, 170, 0.2);
}

.map-popup-trip-item:hover::before {
    width: 100%;
}

.map-popup-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f5f5f5, #e5e5e5);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    z-index: 2;
    font-size: 18px;
    color: #666;
}

.map-popup-close:hover {
    background: linear-gradient(135deg, #20B2AA, #48D1CC);
    color: white;
    transform: rotate(90deg);
}

.trip-status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

.trip-status-badge.has-driver {
    background: #dcfce7;
    color: #16a34a;
}

.trip-status-badge.no-driver {
    background: #fef3c7;
    color: #d97706;
}
        
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 99999;
            pointer-events: none;
        }
        .toast {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 4px solid;
        }
        .toast.success {
            border-left-color: #20B2AA;
        }
        .toast.error {
            border-left-color: #ef4444;
        }
        .toast.info {
            border-left-color: #3b82f6;
        }
        .toast-icon {
            font-size: 1.5rem;
        }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .toast-message {
            font-size: 0.875rem;
            color: #6b7280;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            z-index: 100000 !important;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #20B2AA;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #20B2AA;
            color: white;
            border-color: #20B2AA;
        }
        
        .pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gray-50">
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Navigation Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center" style="height: 64px;">
                    <div class="flex items-center">
                        <!-- Driver-adz Logo -->
                        <svg width="40" height="40" viewBox="0 0 200 200" class="mr-3">
                            <circle cx="100" cy="100" r="90" fill="#000000" />
                            <circle cx="40" cy="100" r="8" fill="#20B2AA" />
                            <circle cx="50" cy="75" r="6" fill="#20B2AA" />
                            <circle cx="50" cy="125" r="6" fill="#20B2AA" />
                            <circle cx="60" cy="55" r="5" fill="#20B2AA" />
                            <circle cx="60" cy="145" r="5" fill="#20B2AA" />
                            <circle cx="70" cy="40" r="4" fill="#20B2AA" />
                            <circle cx="70" cy="160" r="4" fill="#20B2AA" />
                            <g transform="translate(100, 100)">
                                <path d="M -20,-30 L 0,0 L 20,-30" stroke="#20B2AA" stroke-width="3" fill="none" />
                                <path d="M -30,0 L 0,0 L 30,0" stroke="#20B2AA" stroke-width="3" fill="none" />
                                <path d="M -20,30 L 0,0 L 20,30" stroke="#20B2AA" stroke-width="3" fill="none" />
                                <path d="M -30,-20 Q -10,-10 0,0" stroke="#20B2AA" stroke-width="2" fill="none" />
                                <path d="M 30,-20 Q 10,-10 0,0" stroke="#20B2AA" stroke-width="2" fill="none" />
                                <path d="M -30,20 Q -10,10 0,0" stroke="#20B2AA" stroke-width="2" fill="none" />
                                <path d="M 30,20 Q 10,10 0,0" stroke="#20B2AA" stroke-width="2" fill="none" />
                                <circle cx="0" cy="0" r="8" fill="#20B2AA" />
                                <circle cx="-20" cy="-30" r="6" fill="#20B2AA" />
                                <circle cx="20" cy="-30" r="6" fill="#20B2AA" />
                                <circle cx="-30" cy="0" r="6" fill="#20B2AA" />
                                <circle cx="30" cy="0" r="6" fill="#20B2AA" />
                                <circle cx="-20" cy="30" r="6" fill="#20B2AA" />
                                <circle cx="20" cy="30" r="6" fill="#20B2AA" />
                                <circle cx="-30" cy="-20" r="5" fill="#20B2AA" />
                                <circle cx="30" cy="-20" r="5" fill="#20B2AA" />
                                <circle cx="-30" cy="20" r="5" fill="#20B2AA" />
                                <circle cx="30" cy="20" r="5" fill="#20B2AA" />
                            </g>
                        </svg>
                        <div>
                            <h1 class="text-xl font-bold" style="color: #20B2AA">Driver-adz</h1>
                            <p class="text-xs text-gray-500">ระบบวางแผนเส้นทาง</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="toggleNotifications()" class="relative p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100 transition-all">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span class="notification-badge"></span>
                        </button>
                        <button onclick="refreshData()" class="p-2 text-gray-600 hover:text-gray-900 rounded-lg hover:bg-gray-100 transition-all" title="รีเฟรชข้อมูล">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Tab Navigation -->
        <div class="bg-white border-b border-gray-200" style="position: sticky; top: 0; z-index: 40;">
            <div class="px-4 sm:px-6 lg:px-8">
                <nav class="flex" style="gap: 2rem;">
                    <button class="nav-tab active" data-tab="orders" onclick="switchTab('orders')">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ออเดอร์
                    </button>
                    <button class="nav-tab" data-tab="planning" onclick="switchTab('planning')">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        วางแผนเส้นทาง
                    </button>
                    <button class="nav-tab" data-tab="fleet" onclick="switchTab('fleet')">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        จัดการยานพาหนะ
                    </button>
                    <button class="nav-tab" data-tab="drivers" onclick="switchTab('drivers')">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        จัดการคนขับ
                    </button>
                    <button class="nav-tab" data-tab="history" onclick="switchTab('history')">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ประวัติการจัดส่ง
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="px-4 sm:px-6 lg:px-8 py-6">
            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content">
                <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">จัดการออเดอร์</h2>
                    <div class="flex gap-2">
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            อัปโหลดไฟล์
                        </button>
                        <button onclick="downloadTemplate()" class="btn btn-sm btn-secondary">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            เทมเพลต
                        </button>
                        <button onclick="clearAllOrders()" class="btn btn-sm btn-danger">
                            🗑️ เคลียร์
                        </button>
                    </div>
                </div>
                
                <!-- Search Box -->
                <div class="mb-4 bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                    <div class="relative">
                        <input type="text" id="orderSearch" placeholder="ค้นหา: รหัสสาขา, ชื่อสาขา, ที่อยู่..." class="input pl-10" onkeyup="searchOrders()">
                        <svg class="icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mb-4 bg-white rounded-xl shadow-lg border-2 border-gray-900 p-4 hidden">
                    <div class="flex items-center gap-3">
                        <svg class="icon text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-700">กำลังอัปโหลดไฟล์...</p>
                            <div class="mt-2 progress-bar">
                                <div id="progressBar" class="progress-bar-fill bg-gradient-to-r from-gray-700 to-gray-900" style="width: 0%;"></div>
                            </div>
                        </div>
                        <span id="progressText" class="text-lg font-bold text-gray-900">0%</span>
                    </div>
                </div>
                
                <!-- Current Orders Count -->
                <div id="ordersCount" class="mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm font-medium text-yellow-800">
                        📦 จำนวนออเดอร์ที่อัพโหลดไว้: <span id="uploadedOrdersCount" class="font-bold">0</span> รายการ
                    </p>
                </div>
                
                <!-- Orders Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>รหัสสาขา</th>
                                    <th>สาขา</th>
                                    <th>ที่อยู่</th>
                                    <th>LAT</th>
                                    <th>LNG</th>
                                    <th>CBM</th>
                                    <th>น้ำหนัก</th>
                                    <th>จำนวนชิ้น</th>
                                    <th>วันที่ทำการ</th>
                                    <th>เวลาเปิด</th>
                                    <th>เวลาปิด</th>
                                    <th>เวลาลงสินค้า</th>
                                    <th>ประเภทรถ</th>
                                    <th>ผู้ติดต่อ</th>
                                    <th>เบอร์โทร</th>
                                    <th>สถานที่</th>
                                    <th>สถานะ</th>
                                    <th class="text-right">การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="p-4 border-t">
                        <div class="pagination" id="ordersPagination">
                            <!-- Pagination will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Planning Tab Content -->
            <div id="planning-tab" class="tab-content hidden">
                <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">วางแผนเส้นทาง</h2>
                    <button onclick="runRouteOptimization()" class="btn btn-primary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        รันแผน AI
                    </button>
                </div>
                
                <!-- Vehicle Type Selection - Horizontal Layout -->
                <div class="mb-4 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <span class="text-sm font-medium text-gray-700">ประเภทรถ:</span>
                        <div id="vehicleTypeSelection" class="flex flex-wrap gap-3 items-center">
                            <!-- ประเภททั่วไป -->
                            <div class="border-r pr-3 border-gray-300">
                                <span class="text-xs text-gray-500 mr-2">ทั่วไป:</span>
                                <label class="inline-flex items-center gap-1 cursor-pointer mr-2">
                                    <input type="checkbox" name="vehicleTypeFilter" value="4W" class="vehicle-type-checkbox" data-category="general">
                                    <span class="text-sm">4W</span>
                                </label>
                                <label class="inline-flex items-center gap-1 cursor-pointer mr-2">
                                    <input type="checkbox" name="vehicleTypeFilter" value="4WJ" class="vehicle-type-checkbox" data-category="general">
                                    <span class="text-sm">4WJ</span>
                                </label>
                                <label class="inline-flex items-center gap-1 cursor-pointer mr-2">
                                    <input type="checkbox" name="vehicleTypeFilter" value="6W" class="vehicle-type-checkbox" data-category="general">
                                    <span class="text-sm">6W</span>
                                </label>
                                <label class="inline-flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" name="vehicleTypeFilter" value="10W" class="vehicle-type-checkbox" data-category="general">
                                    <span class="text-sm">10W</span>
                                </label>
                            </div>
                            
                            <!-- ประเภทควบคุมอุณหภูมิ -->
                            <div class="border-r pr-3 border-gray-300">
                                <span class="text-xs text-gray-500 mr-2">ควบคุมอุณหภูมิ:</span>
                                <label class="inline-flex items-center gap-1 cursor-pointer mr-2">
                                    <input type="checkbox" name="vehicleTypeFilter" value="COOL4W" class="vehicle-type-checkbox" data-category="temperature">
                                    <span class="text-sm">❄️ 4W</span>
                                </label>
                                <label class="inline-flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" name="vehicleTypeFilter" value="COOL6W" class="vehicle-type-checkbox" data-category="temperature">
                                    <span class="text-sm">❄️ 6W</span>
                                </label>
                            </div>
                            
                            <!-- ประเภทน้ำมัน -->
                            <div>
                                <span class="text-xs text-gray-500 mr-2">น้ำมัน:</span>
                                <label class="inline-flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" name="vehicleTypeFilter" value="OIL" class="vehicle-type-checkbox" data-category="oil">
                                    <span class="text-sm">⛽ รถน้ำมัน</span>
                                </label>
                            </div>
                            
                            <button onclick="selectAllVehicleTypes()" class="text-xs text-blue-600 hover:text-blue-700 ml-2">
                                เลือกทั้งหมด
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Map -->
                <div class="mb-6 bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="relative">
                        <div id="map"></div>
                        
                        <!-- Map Controls -->
                        <div class="map-controls hidden" id="mapControls">
                            <button class="map-control-btn" onclick="showAllMarkers()">
                                📍 แสดงทั้งหมด
                            </button>
                            <button class="map-control-btn" onclick="toggleMapMode()" style="display:none;">
    🖱️ โหมดย้ายสาขา
</button>
                        </div>
                        
                        <!-- Trip Filter -->
                        <div class="trip-filter hidden" id="tripFilter">
                            <h5>🚛 กรองตามทริป</h5>
                            <div id="tripFilterList">
                                <!-- Trip checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6" id="statisticsCards">
                    <!-- Statistics cards will be dynamically inserted here -->
                </div>
                
                <!-- Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                🚛 Filter Vehicle Type:
                            </label>
                            <select id="vehicleTypeFilter" class="select" onchange="filterTripsAndMap()">
                                <option value="">ทุกประเภทรถ</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                📦 Filter by CBM Range:
                            </label>
                            <select id="cbmRangeFilter" class="select" onchange="filterTripsAndMap()">
                                <option>ทุกช่วง CBM</option>
                                <option>0-10 CBM</option>
                                <option>10-20 CBM</option>
                                <option>20-30 CBM</option>
                                <option>30+ CBM</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
                                ⚙️ Quick Actions:
                            </label>
                            <div class="flex gap-2">
                                <button onclick="showCBMAnalysis()" class="flex-1 px-3 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:shadow-md transition-all text-sm font-medium">
                                    รายละเอียด CBM
                                </button>
                                <button onclick="showDistanceAnalysis()" class="flex-1 px-3 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:shadow-md transition-all text-sm font-medium">
                                    วิเคราะห์ระยะทาง
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Confirm Plan Section -->
                <div id="confirmPlanSection" class="confirm-plan-section hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                        <h3 class="text-lg font-bold text-green-800 mb-3">แผนการจัดส่งพร้อมใช้งาน</h3>
                        <p class="text-sm text-green-700 mb-4">กรุณาตรวจสอบความถูกต้องของแผนการจัดส่งและคนขับ หากพร้อมแล้วคลิกปุ่มด้านล่าง</p>
                        <button onclick="confirmPlan()" class="btn btn-primary">
                            ✅ ยืนยันใช้แผนนี้
                        </button>
                    </div>
                </div>
                
                <!-- Trip Cards Container -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="tripCardsContainer">
                    <!-- Trip cards will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- Fleet Management Tab Content -->
            <div id="fleet-tab" class="tab-content hidden">
                <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">จัดการยานพาหนะ</h2>
                    <div class="flex gap-3">
                        <button onclick="showAddVehicleForm()" class="btn btn-primary">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            เพิ่มประเภทรถใหม่
                        </button>
                        <button onclick="exportData('Vehicles')" class="btn btn-secondary">
                            📥 Export Vehicles
                        </button>
                    </div>
                </div>
                
                <!-- Vehicle Types Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-teal-500 to-cyan-500 px-6 py-4" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                        <h3 class="text-lg font-bold text-white">ประเภทรถที่ลงทะเบียน</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>รหัส</th>
                                    <th>ชื่อประเภทรถ</th>
                                    <th>หมวดหมู่</th>
                                    <th>น้ำหนักสูงสุด (kg)</th>
                                    <th>ปริมาตร (CBM)</th>
                                    <th>จุดส่งสูงสุด</th>
                                    <th>ระยะทางวิ่งสูงสุด (กม.)</th>
                                    <th>ต้นทุน/กม.</th>
                                    <th class="text-right">การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleTypesTableBody">
                                <!-- Vehicle types will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Drivers Tab Content -->
            <div id="drivers-tab" class="tab-content hidden">
                <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">จัดการคนขับ</h2>
                    <div class="flex gap-3">
                        <button onclick="showAddDriverForm()" class="btn btn-primary">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            เพิ่มคนขับใหม่
                        </button>
                        <button onclick="exportData('Drivers')" class="btn btn-secondary">
                            📥 Export Drivers
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="driversGrid">
                    <!-- Driver cards will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- History Tab Content -->
            <div id="history-tab" class="tab-content hidden">
                <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">ประวัติการจัดส่ง</h2>
                    <div class="flex items-center gap-3">
                        <button onclick="filterToday()" class="btn btn-secondary">
                            📅 วันนี้
                        </button>
                        <input type="date" id="historyDate" class="input" style="width: auto;" onchange="filterHistory()">
                        <button onclick="exportDetailedHistory()" class="btn btn-secondary">
                            📥 Export รายละเอียด
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="historyGrid">
                    <!-- History cards will be dynamically inserted here -->
                </div>
            </div>
        </main>
        
        <!-- Modals -->
        <!-- Add Vehicle Form Modal -->
        <div id="addVehicleModal" class="modal-backdrop hidden">
            <div class="modal">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-gradient-to-br from-teal-500 to-cyan-500 p-3 rounded-xl" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                        <svg class="icon-lg text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">เพิ่มประเภทรถใหม่</h3>
                </div>
                
                <form id="addVehicleForm">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">รหัสรถ</label>
                            <input type="text" name="code" class="input" placeholder="เช่น 10W, TRAILER" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อประเภทรถ</label>
                            <input type="text" name="name" class="input" placeholder="เช่น รถบรรทุก 10 ล้อ" required>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                            <div class="grid grid-cols-3 gap-3" id="vehicleCategorySelect">
                                <!-- Category buttons will be dynamically inserted here -->
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">น้ำหนักสูงสุด (kg)</label>
                            <input type="number" name="maxWeight" class="input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ปริมาตร (CBM)</label>
                            <input type="number" name="maxCBM" class="input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">จุดส่งสูงสุด</label>
                            <input type="number" name="maxDestinations" class="input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ระยะทางวิ่งสูงสุด (กม.)</label>
                            <input type="number" name="maxDistance" class="input" required>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ต้นทุนต่อกิโลเมตร (บาท)</label>
                            <input type="number" name="costPerKm" step="0.01" class="input" required>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-8">
                        <button type="submit" class="flex-1 btn btn-primary">บันทึกข้อมูล</button>
                        <button type="button" onclick="hideAddVehicleForm()" class="flex-1 btn btn-secondary">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Add Driver Form Modal -->
        <div id="addDriverModal" class="modal-backdrop hidden">
            <div class="modal" style="max-width: 48rem; max-height: 90vh; overflow-y: auto;">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-gradient-to-br from-teal-500 to-cyan-500 p-3 rounded-xl" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                        <svg class="icon-lg text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">เพิ่มข้อมูลคนขับ</h3>
                </div>
                <form id="addDriverForm">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                            <input type="text" name="name" class="input" placeholder="เช่น สมชาย ทองดี" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทรศัพท์</label>
                            <input type="tel" name="phone" class="input" placeholder="081-234-5678" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทใบขับขี่</label>
                            <select name="licenseType" class="select" required>
                                <option value="">เลือกประเภทใบขับขี่</option>
                                <option value="ท.1">ท.1</option>
                                <option value="ท.2">ท.2</option>
                                <option value="ท.3">ท.3</option>
                                <option value="ท.4">ท.4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">เลขใบขับขี่</label>
                            <input type="text" name="licenseNo" class="input" placeholder="ท.21/12345" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันหมดอายุใบขับขี่</label>
                            <input type="date" name="licenseExpiry" class="input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันเริ่มงาน</label>
                            <input type="date" name="startDate" class="input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทรถที่ขับได้</label>
                            <div class="flex flex-wrap gap-2" id="vehicleTypesCheckboxes">
                                <!-- Vehicle type checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">พื้นที่รับผิดชอบ</label>
                            <input type="text" name="area" class="input" placeholder="เช่น กรุงเทพฯ" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">บริษัทต้นสังกัด</label>
                            <input type="text" name="company" class="input" placeholder="ABC Logistic Co.,Ltd." required>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-8">
                        <button type="submit" class="flex-1 btn btn-primary">บันทึกข้อมูล</button>
                        <button type="button" onclick="hideAddDriverForm()" class="flex-1 btn btn-secondary">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Success Modal -->
<div id="successModal" class="success-modal-backdrop hidden">
    <div class="success-modal">
        <!-- ปุ่มปิด X -->
        <button onclick="closeSuccessModal()" class="success-close-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
        
        <!-- ไอคอนหลัก -->
        <div class="success-icon-wrapper">
            <div class="success-icon">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4"/>
                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
            </div>
            <div class="success-icon-bg"></div>
        </div>
        
        <!-- หัวข้อ -->
        <h2 class="success-title">การวางแผนเส้นทางเสร็จสมบูรณ์!</h2>
        <p class="success-subtitle">ระบบ AI ได้วิเคราะห์และจัดเส้นทางที่ดีที่สุดแล้ว</p>
        
        <!-- สถิติ -->
        <div class="success-stats">
            <div class="stat-card">
                <div class="stat-icon">🚛</div>
                <div class="stat-value" id="totalTripsCount">0</div>
                <div class="stat-label">ทริปทั้งหมด</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📍</div>
                <div class="stat-value" id="totalDeliveryPoints">0</div>
                <div class="stat-label">จุดส่งสินค้า</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚡</div>
                <div class="stat-value" id="efficiencyPercentage">0%</div>
                <div class="stat-label">ประสิทธิภาพ</div>
            </div>
        </div>
        
        <!-- ปุ่มดำเนินการ -->
        <div class="success-actions">
            <button onclick="closeSuccessModal()" class="success-btn-primary">
                ดูรายละเอียดแผน
            </button>
            <button onclick="closeSuccessModal()" class="success-btn-secondary">
                ปิด
            </button>
        </div>
    </div>
</div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-2xl p-8 flex flex-col items-center shadow-2xl">
                <div class="animate-pulse">
                    <svg width="120" height="120" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="#000000" />
                        <circle cx="40" cy="100" r="8" fill="#20B2AA" class="animate-ping" />
                        <circle cx="50" cy="75" r="6" fill="#20B2AA" style="opacity: 0.8;" />
                        <circle cx="50" cy="125" r="6" fill="#20B2AA" style="opacity: 0.8;" />
                        <circle cx="60" cy="55" r="5" fill="#20B2AA" style="opacity: 0.6;" />
                        <circle cx="60" cy="145" r="5" fill="#20B2AA" style="opacity: 0.6;" />
                        <circle cx="70" cy="40" r="4" fill="#20B2AA" style="opacity: 0.4;" />
                        <circle cx="70" cy="160" r="4" fill="#20B2AA" style="opacity: 0.4;" />
                        <g transform="translate(100, 100)">
                            <path d="M -20,-30 L 0,0 L 20,-30" stroke="#20B2AA" stroke-width="3" fill="none" />
                            <path d="M -30,0 L 0,0 L 30,0" stroke="#20B2AA" stroke-width="3" fill="none" />
                            <path d="M -20,30 L 0,0 L 20,30" stroke="#20B2AA" stroke-width="3" fill="none" />
                            <circle cx="0" cy="0" r="8" fill="#20B2AA" />
                        </g>
                    </svg>
                </div>
                <h3 class="mt-4 text-2xl font-bold" style="color: #20B2AA;">Driver-adz</h3>
                <p class="mt-2 text-gray-600" id="loadingText">กำลังประมวลผล...</p>
                <div class="mt-4 w-64 progress-bar">
                    <div class="progress-bar-fill bg-gradient-to-r from-teal-500 to-cyan-500 animate-pulse" style="width: 70%;"></div>
                </div>
            </div>
        </div>
        <!-- Move Branch Modal -->
<div id="moveBranchModal" class="modal-backdrop hidden">
    <div class="modal" style="max-width: 600px;">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-blue-500 to-purple-500 p-3 rounded-xl">
                    <span class="text-2xl text-white">🚚</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">ย้ายสาขา</h3>
                    <p class="text-sm text-gray-600 mt-1" id="moveBranchTitle">เลือกทริปที่ต้องการย้ายไป</p>
                </div>
            </div>
            <button onclick="closeMoveBranchModal()" class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg">
                ✕
            </button>
        </div>
        
        <!-- ช่องค้นหา -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="tripSearchInput" 
                       placeholder="🔍 ค้นหาทริป... (พิมพ์รหัสทริป หรือประเภทรถ)" 
                       class="input pl-10"
                       onkeyup="filterTripOptions()">
                <svg class="icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>
        
        <!-- ข้อมูลสาขาที่จะย้าย -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" id="movingBranchInfo">
            <!-- ข้อมูลจะแสดงที่นี่ -->
        </div>
        
        <!-- รายการทริป -->
        <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">เลือกทริปปลายทาง:</p>
            <div id="tripOptionsList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- รายการทริปจะแสดงที่นี่ -->
            </div>
        </div>
        
        <!-- ปุ่มยกเลิก -->
        <div class="flex gap-3">
            <button onclick="closeMoveBranchModal()" class="w-full btn btn-secondary">
                ยกเลิก
            </button>
        </div>
    </div>
</div>
        <!-- Move Branch Modal -->
<div id="moveBranchModal" class="modal-backdrop hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-blue-500 to-purple-500 p-3 rounded-xl">
                    <span class="text-2xl text-white">🚚</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">ย้ายสาขา</h3>
                    <p class="text-sm text-gray-600 mt-1" id="moveBranchTitle">เลือกทริปที่ต้องการย้ายไป</p>
                </div>
            </div>
            <button onclick="closeMoveBranchModal()" class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg">
                ✕
            </button>
        </div>
        
        <!-- ช่องค้นหา -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="tripSearchInput" 
                       placeholder="🔍 ค้นหาทริป... (พิมพ์รหัสทริป หรือประเภทรถ)" 
                       class="input pl-10"
                       onkeyup="filterTripOptions()">
                <svg class="icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>
        
        <!-- ข้อมูลสาขาที่จะย้าย -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" id="movingBranchInfo">
            <!-- ข้อมูลจะแสดงที่นี่ -->
        </div>
        
        <!-- รายการทริป -->
        <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">เลือกทริปปลายทาง:</p>
            <div id="tripOptionsList" class="max-h-96 overflow-y-auto space-y-2">
                <!-- รายการทริปจะแสดงที่นี่ -->
            </div>
        </div>
        
        <!-- ปุ่มยกเลิก -->
        <div class="flex gap-3">
            <button onclick="closeMoveBranchModal()" class="w-full btn btn-secondary">
                ยกเลิก
            </button>
        </div>
    </div>
</div>
        
        <!-- Notifications Dropdown -->
        <div id="notificationsDropdown" class="absolute right-4 top-16 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden hidden" style="z-index: 9999;">
            <div class="bg-gradient-to-r from-teal-500 to-cyan-500 p-4 text-white" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                <h3 class="font-bold text-lg">การแจ้งเตือน</h3>
            </div>
            <div class="max-h-96 overflow-y-auto" id="notificationsList">
                <!-- Notifications will be dynamically inserted here -->
            </div>
        </div>
        
       <!-- Map Move Branch Popup - Modern Design -->
<div id="mapBranchPopup" class="map-popup hidden">
    <button class="map-popup-close" onclick="closeMapPopup()">✕</button>
    <div class="map-popup-header" id="mapPopupHeader">
        เลือกทริปที่ต้องการย้ายไป
    </div>
    <!-- Content จะถูกใส่ด้วย JavaScript -->
</div>
    </div>
    
    <script>
        // ===== API KEYS =====
        const GEMINI_API_KEY = 'AIzaSyB__ZrGytmV023l0cE1WSFoNEjBt9AbUr0';
        const GOOGLE_MAPS_API_KEY = 'AIzaSyCc62fmzeQ1I2ACl8f926bum8CY25TdESM';
        // ===== ค่าคงที่สำหรับจุด Start/End =====
const DEPOT_LOCATION = {
    lat: 14.060704,
    lng: 99.801676,
    name: "คลังสินค้า"
};
// ===== ฟังก์ชันแยกจังหวัดจากที่อยู่ =====
function extractProvince(address) {
    // รายชื่อจังหวัดในประเทศไทย
    const provinces = [
        'กรุงเทพมหานคร', 'กรุงเทพฯ', 'กทม.', 'กรุงเทพ',
        'สมุทรปราการ', 'นนทบุรี', 'ปทุมธานี', 'สมุทรสาคร', 'สมุทรสงคราม',
        'นครปฐม', 'ราชบุรี', 'กาญจนบุรี', 'สุพรรณบุรี', 'พระนครศรีอยุธยา',
        'อ่างทอง', 'ลพบุรี', 'สิงห์บุรี', 'ชัยนาท', 'สระบุรี',
        'ชลบุรี', 'ระยอง', 'จันทบุรี', 'ตราด', 'ฉะเชิงเทรา',
        'ปราจีนบุรี', 'นครนายก', 'สระแก้ว', 'นครราชสีมา', 'บุรีรัมย์',
        // เพิ่มจังหวัดอื่นๆ ตามต้องการ
    ];
    
    for (let province of provinces) {
        if (address.includes(province)) {
            // แปลงชื่อย่อให้เป็นชื่อเต็ม
            if (province === 'กรุงเทพฯ' || province === 'กทม.' || province === 'กรุงเทพ') {
                return 'กรุงเทพมหานคร';
            }
            return province;
        }
    }
    return 'ไม่ระบุจังหวัด';
}
        // State Management
        let state = {
            activeTab: 'orders',
            selectedVehicleType: 'ทุกประเภทรถ',
            showNotifications: false,
            isOptimizing: false,
            draggedBranch: null,
            draggedFromTrip: null,
            selectedForDrag: null,
            dropTarget: null,
            uploadProgress: 0,
            selectedVehicleCategory: '',
            map: null,
            markers: [],
            branchMarkers: {},
            directionsService: null,
            directionsRenderers: [],
            currentPage: 1,
            rowsPerPage: 50,
            planningVehicleType: '',
            tripColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'],
            mapMode: 'view',
            visibleTrips: [],
            selectedMapBranch: null
        };
        
        // Data Arrays
        let orders = [];
        let vehicleTypes = [];
        let drivers = [];
        let trips = [];
        let deliveryHistory = [];
        let notifications = [
            { id: 1, type: 'new', message: 'มีออเดอร์ใหม่ 5 รายการรอการวางแผน', time: '5 นาทีที่แล้ว' },
            { id: 2, type: 'update', message: 'แผนการจัดส่ง 6W005 ถูกปรับเปลี่ยน', time: '15 นาทีที่แล้ว' },
            { id: 3, type: 'complete', message: 'การจัดส่ง 6W003 เสร็จสมบูรณ์', time: '1 ชั่วโมงที่แล้ว' }
        ];
        
        const vehicleCategories = [
            { name: 'รถบรรทุก 4 ล้อ', description: 'เช่น 4W, 4WJ (4 ล้อจัมโบ้)', icon: '🚛' },
            { name: 'รถบรรทุก 6 ล้อ', description: 'ใช้บ่อยในขนส่งสินค้าระดับกลาง', icon: '🚚' },
            { name: 'รถบรรทุก 10 ล้อ', description: 'สำหรับสินค้าหนัก ระยะไกล', icon: '🚛' },
            { name: 'รถเทรลเลอร์ / หัวลาก (18 ล้อ)', description: 'สำหรับตู้คอนเทนเนอร์หรือขนสินค้าหนักมาก', icon: '🚚' },
            { name: 'รถควบคุมอุณหภูมิ', description: 'รถตู้เย็น ใช้ขนสินค้าที่ต้องรักษาอุณหภูมิ เช่น อาหาร', icon: '❄️' },
            { name: 'รถตู้ (Van)', description: 'บรรทุกคนหรือของ', icon: '🚐' },
        ];
        // ===== ฟังก์ชันลากและวางทริป =====
        let draggedTrip = null;

        function dragStart(e, tripId) {
            draggedTrip = tripId;
            e.dataTransfer.effectAllowed = 'move';
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dropTrip(e, targetTripId) {
            e.preventDefault();
            if (draggedTrip && draggedTrip !== targetTripId) {
                if (confirm(`ต้องการรวม ${draggedTrip} เข้ากับ ${targetTripId}?`)) {
                    mergeTrips(draggedTrip, targetTripId);
                }
            }
            draggedTrip = null;
        }

        // ฟังก์ชันรวมทริป
        function mergeTrips(fromId, toId) {
            const fromTrip = trips.find(t => t.id === fromId);
            const toTrip = trips.find(t => t.id === toId);
            
            if (fromTrip && toTrip) {
                // ย้ายสาขาทั้งหมด
                toTrip.branchList.push(...fromTrip.branchList);
                toTrip.branches = toTrip.branchList.length;
                toTrip.cbm += fromTrip.cbm;
                toTrip.weight += fromTrip.weight;
                
                // ลบทริปต้นทาง
                trips = trips.filter(t => t.id !== fromId);
                
                // บันทึกและรีเฟรช
                persistTrips();
                renderTripCards();
                showNotification(`รวม ${fromId} เข้ากับ ${toId} สำเร็จ!`, 'success');
            }
        }

        

        // ===== STORAGE FUNCTIONS =====
        
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }
        
        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from storage:', error);
                return null;
            }
        }
        
        function persistOrders() {
            saveToStorage('driver_adz_orders', orders);
            updateOrdersCount();
        }
        
        function persistTrips() {
            saveToStorage('driver_adz_trips', trips);
        }
        
        function persistDeliveryHistory() {
            saveToStorage('driver_adz_history', deliveryHistory);
        }
        
        function loadPersistedData() {
            const savedOrders = loadFromStorage('driver_adz_orders');
            if (savedOrders && savedOrders.length > 0) {
                orders = savedOrders;
            }
            
            const savedTrips = loadFromStorage('driver_adz_trips');
            if (savedTrips && savedTrips.length > 0) {
                trips = savedTrips;
            }
            
            const savedHistory = loadFromStorage('driver_adz_history');
            if (savedHistory && savedHistory.length > 0) {
                deliveryHistory = savedHistory;
            }
            
            const savedVehicleTypes = loadFromStorage('driver_adz_vehicles');
            if (savedVehicleTypes && savedVehicleTypes.length > 0) {
                vehicleTypes = savedVehicleTypes;
            }
            
            const savedDrivers = loadFromStorage('driver_adz_drivers');
            if (savedDrivers && savedDrivers.length > 0) {
                drivers = savedDrivers;
            }
        }
        
        function updateOrdersCount() {
            const countElement = document.getElementById('uploadedOrdersCount');
            if (countElement) {
                countElement.textContent = orders.length;
            }
        }
        
        // ===== UI HELPER FUNCTIONS =====
        
        function showLoading(message = 'กำลังประมวลผล...') {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = message;
            }
            loadingOverlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            const title = type === 'success' ? 'สำเร็จ' : type === 'error' ? 'ข้อผิดพลาด' : 'ข้อมูล';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 5000);
        }
        
        // Tab Switching
        function switchTab(tabName) {
            state.activeTab = tabName;
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            if (tabName === 'orders') {
                renderOrdersTable();
                updateOrdersCount();
            } else if (tabName === 'planning') {
                renderStatisticsCards();
                renderTripCards();
                updateVehicleTypeFilter();
                checkConfirmButtonVisibility();
                setTimeout(() => {
                    if (!state.map) {
                        initializeGoogleMap();
                    }
                    if (trips.length > 0) {
                        drawOptimizedRoutes();
                        updateTripFilterList();
                    }
                }, 100);
            } else if (tabName === 'fleet') {
                renderVehicleTypesTable();
            } else if (tabName === 'drivers') {
                renderDriversGrid();
            } else if (tabName === 'history') {
                renderHistoryGrid();
            }
        }
        
        // Google Maps Functions
        function initializeGoogleMap() {
    state.map = new google.maps.Map(document.getElementById('map'), {
        center: DEPOT_LOCATION,
        zoom: 10,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    });
    
    state.directionsService = new google.maps.DirectionsService();
    
    // เพิ่มหมุดคลังสินค้า
    const depotMarker = new google.maps.Marker({
        position: DEPOT_LOCATION,
        map: state.map,
        title: DEPOT_LOCATION.name,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#FF0000',
            fillOpacity: 1,
            strokeColor: '#FFFFFF',
            strokeWeight: 3,
            scale: 15
        },
        label: {
            text: '🏭',
            fontSize: '20px'
        }
    });
    
    // แสดงหมุดสำหรับทุก order ที่มี lat/lng
    if (orders.length > 0) {
        orders.forEach(order => {
            if (order.lat && order.lng) {
                const marker = new google.maps.Marker({
                    position: { lat: order.lat, lng: order.lng },
                    map: state.map,
                    title: order.branch,
                    label: {
                        text: '📍',
                        fontSize: '20px'
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 5px 0; color: #20B2AA;">
                                <strong>${order.branch}</strong>
                            </h4>
                            <p style="margin: 3px 0; font-size: 12px;">
                                📦 น้ำหนัก: ${order.weight.toLocaleString()} kg<br>
                                📦 CBM: ${order.cbm}<br>
                                📍 ${order.address}<br>
                                ⏰ ${order.openTime} - ${order.closeTime}<br>
                                📋 สถานะ: ${order.status}
                            </p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(state.map, marker);
                });
                
                state.markers.push(marker);
            }
        });
        
        // ปรับ zoom ให้เห็นทุกหมุด
        if (state.markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(DEPOT_LOCATION);
            state.markers.forEach(marker => {
                bounds.extend(marker.getPosition());
            });
            state.map.fitBounds(bounds);
        }
    }
}
 // 🔴 ฟังก์ชันอัพเดทหมุดบนแผนที่
function updateMapMarkers() {
    // เคลียร์หมุดเก่า
    if (state.markers) {
        state.markers.forEach(marker => marker.setMap(null));
    }
    state.markers = [];
    
    // เพิ่มหมุดคลังสินค้า
    const depotMarker = new google.maps.Marker({
        position: DEPOT_LOCATION,
        map: state.map,
        title: DEPOT_LOCATION.name,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#FF0000',
            fillOpacity: 1,
            strokeColor: '#FFFFFF',
            strokeWeight: 3,
            scale: 15
        },
        label: {
            text: '🏭',
            fontSize: '20px'
        }
    });
    
    // เพิ่มหมุดสำหรับ orders ใหม่
    orders.forEach(order => {
        if (order.lat && order.lng) {
            const marker = new google.maps.Marker({
                position: { lat: order.lat, lng: order.lng },
                map: state.map,
                title: order.branch,
                label: {
                    text: '📍',
                    fontSize: '20px'
                }
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 5px 0; color: #20B2AA;">
                            <strong>${order.branch}</strong>
                        </h4>
                        <p style="margin: 3px 0; font-size: 12px;">
                            📦 น้ำหนัก: ${order.weight.toLocaleString()} kg<br>
                            📦 CBM: ${order.cbm}<br>
                            📍 ${order.address}<br>
                            ⏰ ${order.openTime} - ${order.closeTime}<br>
                            📋 สถานะ: ${order.status}
                        </p>
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(state.map, marker);
            });
            
            state.markers.push(marker);
        }
    });
    
    // ปรับ zoom ให้เห็นทุกหมุด
    if (state.markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(DEPOT_LOCATION);
        state.markers.forEach(marker => {
            bounds.extend(marker.getPosition());
        });
        state.map.fitBounds(bounds);
    }
}       
        function drawOptimizedRoutes() {
    if (!state.map) return;
    
    // Clear existing routes and markers
    state.directionsRenderers.forEach(renderer => {
        renderer.setMap(null);
    });
    state.directionsRenderers = [];
    
    state.markers.forEach(marker => {
        marker.setMap(null);
    });
    state.markers = [];
    state.branchMarkers = {};
    
    const tripsToShow = state.visibleTrips && state.visibleTrips.length > 0 
        ? trips.filter(trip => state.visibleTrips.includes(trip.id))
        : trips;
    
    tripsToShow.forEach((trip, index) => {
        const color = state.tripColors[index % state.tripColors.length];
        
        // แก้ไขส่วนนี้ - เปลี่ยนจากเดิม
        if (trip.locations && trip.locations.length > 2) {
            const waypoints = trip.locations.slice(1, -1).map(loc => ({
                location: { lat: loc.lat, lng: loc.lng },
                stopover: true
            }));
            
            const request = {
                origin: trip.locations[0],
                destination: trip.locations[trip.locations.length - 1],
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                optimizeWaypoints: false,
                avoidHighways: false,
                avoidTolls: false
            };
            
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: state.map,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: color,
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            
            state.directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Update trip distance from actual route calculation
                    const route = result.routes[0];
                    let totalDistance = 0;
                    route.legs.forEach(leg => {
                        totalDistance += leg.distance.value;
                    });
                    
                    const tripToUpdate = trips.find(t => t.id === trip.id);
                    if (tripToUpdate) {
                        tripToUpdate.distance = Math.round(totalDistance / 1000); // Convert to km
                        persistTrips();
                        renderTripCards();
                        renderStatisticsCards();
                    }
                }
            });
            
            state.directionsRenderers.push(directionsRenderer);
        }
        
        // Create markers for each location
        trip.locations.forEach((location, locIndex) => {
            // ข้ามการสร้าง marker สำหรับคลัง (จุดแรกและจุดสุดท้าย)
            if (locIndex === 0 || locIndex === trip.locations.length - 1) {
                return;
            }
            
            const marker = new google.maps.Marker({
                position: { lat: location.lat, lng: location.lng },
                map: state.map,
                title: location.name,
                label: {
                    text: locIndex.toString(),
                    color: 'white',
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: color,
                    fillOpacity: 0.9,
                    strokeColor: 'white',
                    strokeWeight: 2,
                    scale: 20
                }
            });
            
            // Store marker reference for map mode functionality
            const branchKey = `${trip.id}-${location.name}`;
            state.branchMarkers[branchKey] = marker;
            
            // Add click listener for map mode
marker.addListener('click', (event) => {
    // 🔴 แสดง popup ทันทีไม่ต้องเช็คโหมด
    showMapBranchPopup(location.name, trip.id, event.latLng);
});
                
                           
         
            state.markers.push(marker);
        });
    });
    
    // เพิ่มหมุดคลังสินค้า
    const depotMarker = new google.maps.Marker({
        position: DEPOT_LOCATION,
        map: state.map,
        title: DEPOT_LOCATION.name,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#FF0000',
            fillOpacity: 1,
            strokeColor: '#FFFFFF',
            strokeWeight: 3,
            scale: 15
        },
        label: {
            text: '🏭',
            fontSize: '20px'
        }
    });
    
    if (state.markers.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(DEPOT_LOCATION);
        state.markers.forEach(marker => {
            bounds.extend(marker.getPosition());
        });
        state.map.fitBounds(bounds);
    }
}
        
        function showMapBranchPopup(branchName, fromTripId, latLng) {
    const popup = document.getElementById('mapBranchPopup');
    const header = document.getElementById('mapPopupHeader');
    const tripsList = document.getElementById('mapPopupTrips');
    const tripFilter = document.getElementById('tripFilter');
    
    if (tripFilter) {
        tripFilter.style.opacity = '0.3';
        tripFilter.style.pointerEvents = 'none';
    }
    
    // Update header ด้วยดีไซน์ใหม่
    header.innerHTML = `
        <div>
            <div class="font-bold text-xl text-gray-800">📍 ${branchName}</div>
            <div class="text-sm text-gray-500 mt-1">เลือกทริปที่ต้องการย้ายไป</div>
        </div>
    `;
    
    // เพิ่มช่องค้นหา
    const searchHTML = `
        <div class="map-popup-search">
            <svg class="map-popup-search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" 
                   id="mapTripSearch" 
                   placeholder="🔍 ค้นหาชื่อทริป..." 
                   onkeyup="filterMapTripsPopup()"
                   autocomplete="off">
        </div>
    `;
    
    // Generate trip options ด้วยดีไซน์ใหม่
    const availableTrips = trips.filter(t => t.id !== fromTripId);
    
    let tripsHTML = '';
    if (availableTrips.length === 0) {
        tripsHTML = `
            <div class="text-center text-gray-500 py-8">
                <div style="font-size: 3rem; margin-bottom: 1rem;">😔</div>
                <p>ไม่มีทริปอื่นที่สามารถย้ายไปได้</p>
            </div>
        `;
    } else {
        tripsHTML = availableTrips.map((trip, index) => {
            const color = state.tripColors[trips.indexOf(trip) % state.tripColors.length];
            const hasDriver = trip.driver ? true : false;
            const utilizationPercent = Math.round(trip.utilization);
            const utilizationColor = utilizationPercent >= 90 ? '#ef4444' : 
                                   utilizationPercent >= 70 ? '#f59e0b' : '#10b981';
            
            return `
                <div class="map-popup-trip-item" 
                     onclick="confirmMapMove('${branchName}', '${fromTripId}', '${trip.id}')"
                     data-trip-name="${trip.id.toLowerCase()}"
                     style="border-left: 4px solid ${color};">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <span class="font-bold text-lg" style="color: ${color};">
                                    ${trip.id}
                                </span>
                                <span class="trip-status-badge ${hasDriver ? 'has-driver' : 'no-driver'}">
                                    ${hasDriver ? '✅ มีคนขับ' : '⚠️ รอคนขับ'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                🚛 ${trip.type} • 📦 ${trip.branches} สาขา
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <div class="text-xs">
                                    <span style="color: ${utilizationColor}; font-weight: 600;">
                                        ${utilizationPercent}%
                                    </span>
                                    <span class="text-gray-500">ใช้งาน</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${trip.cbm.toFixed(1)} / ${getMaxCBM(trip.type)} CBM
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${trip.weight.toLocaleString()} kg
                                </div>
                            </div>
                        </div>
                        <div class="text-2xl" style="opacity: 0.3;">
                            ➡️
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500"
                                 style="width: ${utilizationPercent}%; background-color: ${utilizationColor};">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // รวม HTML ทั้งหมด
    const popupContent = searchHTML + '<div class="map-popup-trips" id="mapPopupTripsList">' + tripsHTML + '</div>';
    
    // ใส่ content หลัง header
    const existingSearch = popup.querySelector('.map-popup-search');
    const existingTrips = popup.querySelector('.map-popup-trips');
    
    if (existingSearch) existingSearch.remove();
    if (existingTrips) existingTrips.remove();
    
    header.insertAdjacentHTML('afterend', popupContent);
    
    // Position popup แบบเดิม
    const mapDiv = document.getElementById('map');
    const mapRect = mapDiv.getBoundingClientRect();
    
    const scale = Math.pow(2, state.map.getZoom());
    const nw = new google.maps.LatLng(
        state.map.getBounds().getNorthEast().lat(),
        state.map.getBounds().getSouthWest().lng()
    );
    
    const worldCoordinateNW = state.map.getProjection().fromLatLngToPoint(nw);
    const worldCoordinate = state.map.getProjection().fromLatLngToPoint(latLng);
    
    const pixelOffset = new google.maps.Point(
        Math.floor((worldCoordinate.x - worldCoordinateNW.x) * scale),
        Math.floor((worldCoordinate.y - worldCoordinateNW.y) * scale)
    );
    
    let left = pixelOffset.x;
    let top = pixelOffset.y;
    
    const popupWidth = 400;
    const popupHeight = 400;
    
    if (left + popupWidth > mapRect.width) {
        left = left - popupWidth - 20;
    } else {
        left = left + 20;
    }
    
    if (top + popupHeight > mapRect.height) {
        top = top - popupHeight - 20;
    } else {
        top = top + 20;
    }
    
    // 🔴 สร้าง backdrop
const backdrop = document.createElement('div');
backdrop.className = 'map-popup-backdrop';
backdrop.id = 'mapPopupBackdrop';
backdrop.onclick = closeMapPopup; // คลิกพื้นหลังเพื่อปิด
document.body.appendChild(backdrop);

// 🔴 แสดง popup (ไม่ต้องกำหนด position เพราะใช้ CSS fixed)
popup.style.left = '';
popup.style.top = '';
popup.classList.remove('hidden');

// Focus ที่ช่องค้นหา
setTimeout(() => {
    const searchInput = document.getElementById('mapTripSearch');
    if (searchInput) searchInput.focus();
}, 100);
    
    // Focus ที่ช่องค้นหา
    setTimeout(() => {
        const searchInput = document.getElementById('mapTripSearch');
        if (searchInput) searchInput.focus();
    }, 100);
}
        // 🔴 ฟังก์ชันค้นหาทริปใน Popup
function filterMapTripsPopup() {
    const searchTerm = document.getElementById('mapTripSearch').value.toLowerCase();
    const tripItems = document.querySelectorAll('.map-popup-trip-item');
    
    let visibleCount = 0;
    tripItems.forEach(item => {
        const tripName = item.getAttribute('data-trip-name');
        if (tripName.includes(searchTerm)) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // แสดงข้อความถ้าไม่พบ
    const tripsList = document.getElementById('mapPopupTripsList');
    if (visibleCount === 0 && searchTerm !== '') {
        const noResultsDiv = document.getElementById('noSearchResults');
        if (!noResultsDiv) {
            tripsList.insertAdjacentHTML('beforeend', `
                <div id="noSearchResults" class="text-center text-gray-500 py-8">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔍</div>
                    <p>ไม่พบทริปที่ค้นหา "${searchTerm}"</p>
                </div>
            `);
        }
    } else {
        const noResultsDiv = document.getElementById('noSearchResults');
        if (noResultsDiv) noResultsDiv.remove();
    }
}
      // 🔴 ฟังก์ชันปิด Popup แบบสวยงาม
function closeMapPopup() {
    const popup = document.getElementById('mapBranchPopup');
    const backdrop = document.getElementById('mapPopupBackdrop');
    
    if (popup) {
        popup.style.transform = 'translate(-50%, -50%) scale(0.9)';
        popup.style.opacity = '0';
        setTimeout(() => {
            popup.classList.add('hidden');
            popup.style.transform = '';
            popup.style.opacity = '';
            popup.style.transition = '';
        }, 300);
    }
    
    // 🔴 ลบ backdrop
    if (backdrop) {
        backdrop.style.opacity = '0';
        setTimeout(() => {
            backdrop.remove();
        }, 300);
    }
    
    // 🔴 เคลียร์ filter ของ trip filter
    const tripFilter = document.getElementById('tripFilter');
    if (tripFilter) {
        setTimeout(() => {
            tripFilter.style.opacity = '1';
            tripFilter.style.pointerEvents = 'auto';
        }, 200);
    }
}
      
        function confirmMapMove(branchName, fromTripId, toTripId) {
            closeMapPopup();
            
            state.dropTarget = {
                branch: { name: branchName },
                fromTripId: fromTripId,
                targetTripId: toTripId
            };
            
            // Find the actual branch data
            const sourceTrip = trips.find(t => t.id === fromTripId);
            if (sourceTrip) {
                const branch = sourceTrip.branchList.find(b => b.name === branchName);
                if (branch) {
                    state.dropTarget.branch = branch;
                }
            }
            
            showDropConfirmModal();
        }
        
        function selectAllVehicleTypes() {
            const checkboxes = document.querySelectorAll('.vehicle-type-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
        }
        
        function getSelectedVehicleTypes() {
            const checkboxes = document.querySelectorAll('.vehicle-type-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function showAllMarkers() {
            if (!state.map || state.markers.length === 0) return;
            
            const bounds = new google.maps.LatLngBounds();
            state.markers.forEach(marker => {
                bounds.extend(marker.getPosition());
            });
            state.map.fitBounds(bounds);
        }
        
        function toggleMapMode() {
            state.mapMode = state.mapMode === 'view' ? 'move' : 'view';
            const btn = document.querySelector('.map-control-btn[onclick="toggleMapMode()"]');
            
            if (state.mapMode === 'move') {
                btn.classList.add('active');
                showNotification('โหมดย้ายสาขา: คลิกที่หมุดเพื่อเลือก แล้วคลิกที่หมุดทริปปลายทาง', 'info');
            } else {
                btn.classList.remove('active');
                clearMapSelection();
            }
        }
        
        function toggleTripFilter() {
    const tripFilter = document.getElementById('tripFilter');
    const btn = document.querySelector('.map-control-btn[onclick="toggleTripFilter()"]');
    
    if (!tripFilter) return;
    
    const isHidden = tripFilter.style.opacity === '0' || tripFilter.style.opacity === '0.3';
    
    if (isHidden) {
        // แสดง trip filter
        tripFilter.style.opacity = '1';
        tripFilter.style.pointerEvents = 'auto';
        tripFilter.style.transform = 'translateY(0)';
        btn.classList.remove('active');
        btn.innerHTML = '🎛️ ซ่อนฟิลเตอร์';
    } else {
        // ซ่อน trip filter
        tripFilter.style.opacity = '0';
        tripFilter.style.pointerEvents = 'none';
        tripFilter.style.transform = 'translateY(10px)';
        btn.classList.add('active');
        btn.innerHTML = '🎛️ แสดงฟิลเตอร์';
    }
}    
        // Order Functions
        function clearAllOrders() {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบออเดอร์ทั้งหมด?')) {
                orders = [];
                persistOrders();
                renderOrdersTable();
                showNotification('เคลียร์ออเดอร์ทั้งหมดแล้ว', 'success');
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadProgress = document.getElementById('uploadProgress');
            uploadProgress.classList.remove('hidden');
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                        showNotification('อัปโหลดไฟล์สำเร็จ! กำลังประมวลผลข้อมูล...', 'success');
                        processUploadedFile(file);
                    }, 500);
                }
            }, 200);
            
            event.target.value = '';
        }
        
        async function processUploadedFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    processCSVData(content);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    showNotification('กำลังประมวลผลไฟล์ Excel...', 'info');
                }
            };
            
            reader.readAsText(file);
        }
        
        function processCSVData(csvContent) {
    const lines = csvContent.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    
    // 🔴 เคลียร์ข้อมูลเก่าทั้งหมด
    orders = [];
    trips = [];  // เคลียร์ทริปเก่า
    
    // 🔴 เคลียร์หมุดบน Map
    if (state.markers && state.markers.length > 0) {
        state.markers.forEach(marker => {
            marker.setMap(null);
        });
        state.markers = [];
    }
    
    // 🔴 เคลียร์เส้นทางบน Map  
    if (state.directionsRenderers && state.directionsRenderers.length > 0) {
        state.directionsRenderers.forEach(renderer => {
            renderer.setMap(null);
        });
        state.directionsRenderers = [];
    }
            
            persistOrders();
    showNotification(`นำเข้าข้อมูล ${orders.length} รายการสำเร็จ!`, 'success');
    renderOrdersTable();
    
    // 🔴 อัพเดทหมุดบน Map ทันที
    if (state.activeTab === 'planning' && state.map) {
        updateMapMarkers();
    }
    
    switchTab('planning');
}
        
        function downloadTemplate() {
            const headers = [
                'รหัสสาขา',
                'สาขา',
                'ที่อยู่',
                'latitude',
                'longitude',
                'CBM',
                'Wgt',
                'จำนวนชิ้น',
                'วันที่ทำการ',
                'เวลาเปิด',
                'เวลาปิด',
                'เวลาลงสินค้า',
                'เงื่อนไขประเภทรถ',
                'ชื่อผู้ติดต่อ',
                'เบอร์โทรผู้ติดต่อ',
                'สถานที่'
            ];
            
            const sampleData = [
                ['BR001', 'สาขาลาดพร้าว', '123 ถ.ลาดพร้าว แขวงลาดพร้าว เขตลาดพร้าว กรุงเทพฯ 10230', '13.8166', '100.5745', '5.2', '1200', '50', '2024-01-20', '08:00', '18:00', '30', 'รถ 6 ล้อ', 'คุณสมชาย', '081-234-5678', 'หน้าร้าน'],
                ['BR002', 'สาขารามอินทรา', '456 ถ.รามอินทรา แขวงอนุสาวรีย์ เขตบางเขน กรุงเทพฯ 10220', '13.8668', '100.6045', '3.8', '850', '35', '2024-01-20', '09:00', '19:00', '25', 'รถ 4 ล้อ', 'คุณสมหญิง', '082-345-6789', 'ลานจอดหลังอาคาร']
            ];
            
            let csvContent = headers.join(',') + '\n';
            sampleData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'order_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ดาวน์โหลดเทมเพลตสำเร็จ!', 'success');
        }
        
        function exportData(dataType) {
            let csvContent = '';
            let filename = '';
            
            if (dataType === 'Vehicles') {
                const headers = ['รหัส', 'ชื่อประเภทรถ', 'หมวดหมู่', 'น้ำหนักสูงสุด', 'ปริมาตร', 'จุดส่งสูงสุด', 'ระยะทางวิ่งสูงสุด', 'ต้นทุน/กม.'];
                csvContent = headers.join(',') + '\n';
                
                vehicleTypes.forEach(vehicle => {
                    const row = [
                        vehicle.code,
                        vehicle.name,
                        vehicle.category,
                        vehicle.maxWeight,
                        vehicle.maxCBM,
                        vehicle.maxDestinations,
                        vehicle.maxDistance || '',
                        vehicle.costPerKm
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                filename = 'vehicles_export.csv';
                
            } else if (dataType === 'Drivers') {
                const headers = ['รหัส', 'ชื่อ-นามสกุล', 'เบอร์โทร', 'ประเภทใบขับขี่', 'เลขใบขับขี่', 'วันหมดอายุ', 'ประเภทรถที่ขับได้', 'พื้นที่', 'บริษัท'];
                csvContent = headers.join(',') + '\n';
                
                drivers.forEach(driver => {
                    const row = [
                        driver.id,
                        driver.name,
                        driver.phone,
                        driver.licenseType,
                        driver.licenseNo,
                        driver.licenseExpiry,
                        driver.vehicleTypes.join(';'),
                        driver.area,
                        driver.company
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                filename = 'drivers_export.csv';
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Export ${dataType} สำเร็จ!`, 'success');
        }
        
        function searchOrders() {
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            const filteredOrders = orders.filter(order => 
                order.branchCode.toLowerCase().includes(searchTerm) ||
                order.branch.toLowerCase().includes(searchTerm) ||
                order.address.toLowerCase().includes(searchTerm)
            );
            
            renderOrdersTable(filteredOrders);
        }
        
        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                showNotification('ฟังก์ชันแก้ไขออเดอร์กำลังพัฒนา', 'info');
            }
        }
        
        function deleteOrder(orderId) {
            if (confirm('ต้องการลบออเดอร์นี้หรือไม่?')) {
                const index = orders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    orders.splice(index, 1);
                    persistOrders();
                    showNotification('ลบออเดอร์สำเร็จ', 'success');
                    renderOrdersTable();
                }
            }
        }
        
      // Geographic clustering function using lat/lng
function groupOrdersByProvince(ordersToOptimize) {
    const provinceGroups = {};
    
    // จัดกลุ่มตามจังหวัดก่อน
    ordersToOptimize.forEach(order => {
        const province = extractProvince(order.address);
        if (!provinceGroups[province]) {
            provinceGroups[province] = [];
        }
        provinceGroups[province].push(order);
    });
    
    // แปลงเป็นรูปแบบที่ใช้ในระบบ
    const grouped = {};
    let clusterIndex = 1;
    
    // เรียงลำดับจังหวัดตามระยะห่างจากคลัง
    const sortedProvinces = Object.keys(provinceGroups).sort((a, b) => {
        const ordersA = provinceGroups[a];
        const ordersB = provinceGroups[b];
        
        // คำนวณระยะทางเฉลี่ยของแต่ละจังหวัดจากคลัง
        const avgDistA = ordersA.reduce((sum, order) => {
            return sum + calculateDistance(DEPOT_LOCATION.lat, DEPOT_LOCATION.lng, order.lat, order.lng);
        }, 0) / ordersA.length;
        
        const avgDistB = ordersB.reduce((sum, order) => {
            return sum + calculateDistance(DEPOT_LOCATION.lat, DEPOT_LOCATION.lng, order.lat, order.lng);
        }, 0) / ordersB.length;
        
        return avgDistA - avgDistB; // เรียงจากใกล้ไปไกล
    });
    
    // สร้าง cluster สำหรับแต่ละจังหวัด
    sortedProvinces.forEach(province => {
        grouped[`${province}_Cluster`] = provinceGroups[province];
        clusterIndex++;
    });
    
    return grouped;
}
      // คำนวณระยะทางระหว่าง 2 จุดในโลก (หน่วย: กิโลเมตร)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // รัศมีโลก = 6371 กม.
    const dLat = toRadians(lat2 - lat1);
    const dLng = toRadians(lng2 - lng1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
             Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
             Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}
// แปลงองศาเป็น radians (สำหรับการคำนวณ)
function toRadians(degrees) {
    return degrees * (Math.PI / 180);
}
        // Route Optimization Functions
        async function runRouteOptimization() {
    const selectedTypes = getSelectedVehicleTypes();
    
    if (selectedTypes.length === 0) {
        showNotification('กรุณาเลือกประเภทรถอย่างน้อย 1 ประเภท', 'error');
        return;
    }
    
    showLoading('กำลังวิเคราะห์และวางแผนเส้นทางด้วย AI...');
          console.log('=== เริ่มการวางแผนเส้นทาง ===');
console.log('จำนวนออเดอร์ทั้งหมด:', orders.length);
console.log('ประเภทรถที่เลือก:', selectedTypes);
    
    // ใช้เฉพาะ order ที่รอวางแผนและไม่ซ้ำ
    const uniqueOrders = orders.filter((order, index, self) => 
        order.status === 'รอวางแผน' && 
        order.lat && 
        order.lng &&
        self.findIndex(o => o.branchCode === order.branchCode) === index
    );
    
    if (uniqueOrders.length === 0) {
        hideLoading();
        showNotification('ไม่มีออเดอร์ที่รอการวางแผน', 'error');
        return;
    }
    
    try {
        // จัดกลุ่มตามจังหวัด
        const ordersClusters = groupOrdersByProvince(uniqueOrders);
        
        // ใช้ AI วิเคราะห์
        const aiInsights = await analyzeWithGeminiAI(uniqueOrders, selectedTypes, ordersClusters);
        
        // สร้างทริปที่เหมาะสม
        const optimizedTrips = await generateOptimizedTrips(ordersClusters, selectedTypes, aiInsights);
        
        trips = optimizedTrips;
        
        // อัพเดทสถานะ order
        uniqueOrders.forEach(order => {
            order.status = 'วางแผนแล้ว';
        });
        
        persistOrders();
        persistTrips();
        
        hideLoading();
        
        // แสดงผลลัพธ์
        updateSuccessModalData(optimizedTrips, aiInsights);
        showSuccessModal();
        
        state.visibleTrips = trips.map(t => t.id);
        drawOptimizedRoutes();
        
        updateTripFilterList();
        renderStatisticsCards();
        renderTripCards();
        renderOrdersTable();
        checkConfirmButtonVisibility();
        
        document.getElementById('mapControls').classList.remove('hidden');
        document.getElementById('tripFilter').classList.remove('hidden');
        
    } catch (error) {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการวางแผนเส้นทาง: ' + error.message, 'error');
    }
}
        
        async function analyzeWithGeminiAI(orders, vehicleTypes, ordersClusters) {
    try {
        // เตรียมข้อมูลรถ
        const vehicleData = vehicleTypes.map(vType => {
            const vehicle = state.vehicleTypes.find(v => v.code === vType) || {
                code: vType,
                maxWeight: vType === '4W' ? 2000 : vType === '6W' ? 5000 : 10000,
                maxCBM: vType === '4W' ? 10 : vType === '6W' ? 20 : 40,
                maxDestinations: vType === '4W' ? 8 : vType === '6W' ? 12 : 15,
                maxDistance: vType === '4W' ? 200 : vType === '6W' ? 300 : 500,
                costPerKm: vType === '4W' ? 12.5 : vType === '6W' ? 18.5 : 25
            };
            return vehicle;
        });
        
        const prompt = `วิเคราะห์และวางแผนเส้นทางขนส่งที่ดีที่สุด:
ข้อมูลออเดอร์ (${orders.length} รายการ):
${JSON.stringify(orders.map(o => ({
    branch: o.branch,
    province: extractProvince(o.address),
    cbm: o.cbm,
    weight: o.weight,
    windowTime: `${o.openTime}-${o.closeTime}`,
    lat: o.lat,
    lng: o.lng
})), null, 2)}
การจัดกลุ่มตามจังหวัด:
${JSON.stringify(Object.keys(ordersClusters).map(key => ({
    cluster: key,
    orderCount: ordersClusters[key].length,
    totalCBM: ordersClusters[key].reduce((sum, o) => sum + o.cbm, 0).toFixed(1),
    totalWeight: ordersClusters[key].reduce((sum, o) => sum + o.weight, 0)
})), null, 2)}
ประเภทรถและต้นทุน:
${JSON.stringify(vehicleData, null, 2)}
จุดเริ่มต้น: ${DEPOT_LOCATION.lat}, ${DEPOT_LOCATION.lng}
กรุณาวิเคราะห์และให้คำแนะนำ:
1. การเลือกประเภทรถที่เหมาะสมสำหรับแต่ละ cluster โดยคำนึงถึงต้นทุน
2. การจัดลำดับการส่งในแต่ละทริปให้เหมาะกับ window time
3. วิธีใช้จำนวนรถน้อยที่สุดแต่ยังมีประสิทธิภาพ
4. การวางแผนเส้นทางแบบ Ant Colony Optimization
5. ข้อแนะนำพิเศษ
ตอบเป็น JSON format`;
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 2048,
                }
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get AI insights');
        }
        
        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;
        
        // พยายามแปลง JSON
        try {
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
        } catch (e) {
            console.error('Failed to parse AI response as JSON:', e);
        }
        
        return {
            insights: aiResponse,
            recommendations: [
                'จัดส่งในจังหวัดเดียวกันก่อนเพื่อประหยัดเวลาและต้นทุน',
                'ใช้รถขนาดเล็กสำหรับพื้นที่ที่มีออเดอร์น้อย',
                'เริ่มส่งจากจุดที่เปิดเร็วก่อน'
            ]
        };
        
    } catch (error) {
        console.error('AI Analysis Error:', error);
        return {
            insights: 'ระบบได้วิเคราะห์โดยใช้ algorithm มาตรฐาน',
            recommendations: [
                'จัดกลุ่มตามจังหวัดแล้ว',
                'เลือกรถตามต้นทุนที่เหมาะสม',
                'คำนึงถึงเวลาเปิด-ปิด'
            ]
        };
    }
}
        function selectOptimalVehicle(orderGroup, availableTypes) {
    // ไม่ต้องคำนวณรวมทั้งหมด เพราะอาจจะมากเกินไป
    // แค่หารถที่เหมาะสมที่สุดตามต้นทุน
    
    let vehicleOptions = [];
    
    availableTypes.forEach(vType => {
        const vehicle = vehicleTypes.find(v => v.code === vType) || {
            code: vType,
            maxWeight: vType === '4W' ? 2000 : vType === '4WJ' ? 3000 : vType === '6W' ? 5000 : vType === '10W' ? 10000 : 5000,
            maxCBM: vType === '4W' ? 10 : vType === '4WJ' ? 15 : vType === '6W' ? 20 : vType === '10W' ? 40 : 20,
            maxDestinations: vType === '4W' ? 8 : vType === '4WJ' ? 10 : vType === '6W' ? 12 : vType === '10W' ? 15 : 10,
            maxDistance: vType === '4W' ? 200 : vType === '4WJ' ? 250 : vType === '6W' ? 300 : vType === '10W' ? 500 : 300,
            costPerKm: vType === '4W' ? 12.5 : vType === '4WJ' ? 15 : vType === '6W' ? 18.5 : vType === '10W' ? 25 : 20
        };
        
        vehicleOptions.push(vehicle);
    });
    
    // เรียงลำดับตามต้นทุนต่อ CBM (ประสิทธิภาพสูงสุด)
    vehicleOptions.sort((a, b) => {
        const efficiencyA = a.costPerKm / a.maxCBM;
        const efficiencyB = b.costPerKm / b.maxCBM;
        return efficiencyA - efficiencyB;
    });
    
    return vehicleOptions; // คืนค่าเป็น array ของรถทั้งหมดที่เรียงตามประสิทธิภาพ
}
// ===== ฟังก์ชันแบ่งออเดอร์ที่ใหญ่เกินไป =====
function splitLargeOrder(order, maxCBM, maxWeight) {
    const splits = [];
    let remainingCBM = order.cbm;
    let remainingWeight = order.weight;
    let splitCount = 1;
    
    // คำนวณจำนวนรอบที่ต้องแบ่ง
    const cbmSplits = Math.ceil(order.cbm / (maxCBM * 0.8)); // ใช้ 80% ของความจุ
    const weightSplits = Math.ceil(order.weight / (maxWeight * 0.8));
    const totalSplits = Math.max(cbmSplits, weightSplits);
    
    // แบ่งเท่าๆ กัน
    const cbmPerSplit = order.cbm / totalSplits;
    const weightPerSplit = order.weight / totalSplits;
    
    for (let i = 0; i < totalSplits; i++) {
        splits.push({
            ...order,
            id: `${order.id}-SPLIT${splitCount}`,
            branch: `${order.branch} (ส่วนที่ ${splitCount}/${totalSplits})`,
            cbm: parseFloat(cbmPerSplit.toFixed(2)),
            weight: Math.round(weightPerSplit),
            pieces: Math.ceil(order.pieces / totalSplits),
            isSplit: true,
            originalId: order.id
        });
        splitCount++;
    }
    
    return splits;
}

// ===== ฟังก์ชันหารถที่เหมาะสมที่สุดตาม Utilization =====
function findBestFitVehicle(orders, availableTypes) {
    let bestOption = null;
    let bestUtilization = 0;
    
    // คำนวณ CBM และน้ำหนักรวม
    const totalCBM = orders.reduce((sum, o) => sum + o.cbm, 0);
    const totalWeight = orders.reduce((sum, o) => sum + o.weight, 0);
    
    availableTypes.forEach(vType => {
        const vehicle = vehicleTypes.find(v => v.code === vType) || {
            code: vType,
            maxWeight: vType === '4W' ? 2000 : vType === '4WJ' ? 3000 : vType === '6W' ? 5000 : vType === '10W' ? 10000 : 5000,
            maxCBM: vType === '4W' ? 10 : vType === '4WJ' ? 15 : vType === '6W' ? 20 : vType === '10W' ? 40 : 20,
            maxDestinations: vType === '4W' ? 8 : vType === '4WJ' ? 10 : vType === '6W' ? 12 : vType === '10W' ? 15 : 10,
            maxDistance: vType === '4W' ? 200 : vType === '4WJ' ? 250 : vType === '6W' ? 300 : vType === '10W' ? 500 : 300,
            costPerKm: vType === '4W' ? 12.5 : vType === '4WJ' ? 15 : vType === '6W' ? 18.5 : vType === '10W' ? 25 : 20
        };
        
        // คำนวณ utilization
        const cbmUtilization = (totalCBM / vehicle.maxCBM) * 100;
        const weightUtilization = (totalWeight / vehicle.maxWeight) * 100;
        const avgUtilization = (cbmUtilization + weightUtilization) / 2;
        
        // เลือกรถที่ utilization ใกล้ 80-95% มากที่สุด
        if (avgUtilization <= 100 && avgUtilization > bestUtilization) {
            bestOption = vehicle;
            bestUtilization = avgUtilization;
        }
    });
    
    return bestOption;
}
// ===== ฟังก์ชันหาชุดออเดอร์ที่ดีที่สุด (Knapsack Problem) =====
function findBestCombination(orders, maxCBM, maxWeight, maxDestinations, maxDistance) {
  if (orders.length === 1 && 
        (orders[0].cbm > maxCBM || orders[0].weight > maxWeight)) {
        return []; // ส่งคืน array ว่าง เพื่อให้ไปแบ่งออเดอร์
    }
    let bestCombination = [];
    let bestUtilization = 0;
    
    // ถ้าออเดอร์น้อย ลองทุกชุดค่าผสม
    if (orders.length <= 10) {
        // Generate all possible combinations
        for (let i = 1; i < Math.pow(2, orders.length); i++) {
            const combination = [];
            let totalCBM = 0;
            let totalWeight = 0;
            let totalDistance = 0;
            let lastLocation = DEPOT_LOCATION;
            
            for (let j = 0; j < orders.length; j++) {
                if (i & (1 << j)) {
                    const order = orders[j];
                    combination.push(order);
                    totalCBM += order.cbm;
                    totalWeight += order.weight;
                    
                    const distance = calculateDistance(
                        lastLocation.lat, lastLocation.lng,
                        order.lat, order.lng
                    );
                    totalDistance += distance;
                    lastLocation = { lat: order.lat, lng: order.lng };
                }
            }
            
            // เพิ่มระยะทางกลับ
            totalDistance += calculateDistance(
                lastLocation.lat, lastLocation.lng,
                DEPOT_LOCATION.lat, DEPOT_LOCATION.lng
            );
            
            // ตรวจสอบข้อจำกัด
            if (totalCBM <= maxCBM && 
                totalWeight <= maxWeight && 
                combination.length <= maxDestinations &&
                totalDistance <= maxDistance) {
                
                const utilization = (totalCBM / maxCBM) * 100;
                if (utilization > bestUtilization) {
                    bestUtilization = utilization;
                    bestCombination = [...combination];
                }
            }
        }
    } else {
        // ถ้าออเดอร์เยอะ ใช้ Greedy Algorithm
        let currentCBM = 0;
        let currentWeight = 0;
        let currentDistance = 0;
        let lastLocation = DEPOT_LOCATION;
        
        // เรียงลำดับตาม value/weight ratio (CBM/ระยะทาง)
        const sortedOrders = orders.map(order => {
            const distance = calculateDistance(DEPOT_LOCATION.lat, DEPOT_LOCATION.lng, order.lat, order.lng);
            return {
                ...order,
                ratio: order.cbm / (distance + 1) // +1 เพื่อหลีกเลี่ยงการหารด้วย 0
            };
        }).sort((a, b) => b.ratio - a.ratio);
        
        for (const order of sortedOrders) {
            const distance = calculateDistance(
                lastLocation.lat, lastLocation.lng,
                order.lat, order.lng
            );
            
            if (currentCBM + order.cbm <= maxCBM && 
                currentWeight + order.weight <= maxWeight && 
                bestCombination.length < maxDestinations &&
                currentDistance + distance <= maxDistance * 0.8) {
                
                bestCombination.push(order);
                currentCBM += order.cbm;
                currentWeight += order.weight;
                currentDistance += distance;
                lastLocation = { lat: order.lat, lng: order.lng };
            }
        }
    }
    
    return bestCombination;
}
        async function generateOptimizedTrips(ordersClusters, selectedVehicleTypes, aiInsights) {
    const allTrips = [];
    let tripCounter = 1;
    let unassignedOrders = []; // เก็บออเดอร์ที่ยังไม่ได้จัดส่ง
    
    // หารถที่ใหญ่ที่สุดเพื่อใช้ตรวจสอบ
    let maxVehicleCBM = 0;
    let maxVehicleWeight = 0;
    
    selectedVehicleTypes.forEach(vType => {
    const vehicle = vehicleTypes.find(v => v.code === vType) || {
        maxWeight: vType === '10W' ? 10000 : 
                  vType === 'TRAILER' ? 25000 : // เพิ่มบรรทัดนี้
                  vType === '6W' ? 5000 : 2000,
        maxCBM: vType === '10W' ? 40 : 
                vType === 'TRAILER' ? 100 : // เพิ่มบรรทัดนี้
                vType === '6W' ? 20 : 10
    };
        maxVehicleCBM = Math.max(maxVehicleCBM, vehicle.maxCBM);
        maxVehicleWeight = Math.max(maxVehicleWeight, vehicle.maxWeight);
    });
    
    // วนลูปแต่ละ cluster (จังหวัด)
    for (const [clusterName, clusterOrders] of Object.entries(ordersClusters)) {
        console.log(`\n=== วางแผนสำหรับ ${clusterName} ===`);
        console.log(`จำนวนออเดอร์: ${clusterOrders.length}`);
        
        // เรียงลำดับตาม CBM จากมากไปน้อย (ใส่ของใหญ่ก่อน)
        let sortedOrders = clusterOrders.sort((a, b) => b.cbm - a.cbm);
        
        // ตรวจสอบและแบ่งออเดอร์ที่ใหญ่เกินไป
        let processedOrders = [];
        sortedOrders.forEach(order => {
            if (order.cbm > maxVehicleCBM || order.weight > maxVehicleWeight) {
                console.log(`⚠️ แบ่งออเดอร์ ${order.branch} (${order.cbm} CBM, ${order.weight} kg)`);
                const splits = splitLargeOrder(order, maxVehicleCBM, maxVehicleWeight);
                processedOrders.push(...splits);
            } else {
                processedOrders.push(order);
            }
        });
        
        let remainingOrders = [...processedOrders];
        
        while (remainingOrders.length > 0) {
            // หาชุดออเดอร์ที่เหมาะสมที่สุดสำหรับรถแต่ละคัน
            let bestTripOption = null;
            let bestUtilization = 0;
            let bestVehicle = null;
            
            // ลองหลายๆ วิธีเพื่อหา utilization ที่ดีที่สุด
            for (const vType of selectedVehicleTypes) {
                const vehicle = vehicleTypes.find(v => v.code === vType) || {
                    code: vType,
                    maxWeight: vType === '4W' ? 2000 : vType === '4WJ' ? 3000 : vType === '6W' ? 5000 : vType === '10W' ? 10000 : 5000,
                    maxCBM: vType === '4W' ? 10 : vType === '4WJ' ? 15 : vType === '6W' ? 20 : vType === '10W' ? 40 : 20,
                    maxDestinations: vType === '4W' ? 8 : vType === '4WJ' ? 10 : vType === '6W' ? 12 : vType === '10W' ? 15 : 10,
                    maxDistance: vType === '4W' ? 200 : vType === '4WJ' ? 250 : vType === '6W' ? 300 : vType === '10W' ? 500 : 300,
                    costPerKm: vType === '4W' ? 12.5 : vType === '4WJ' ? 15 : vType === '6W' ? 18.5 : vType === '10W' ? 25 : 20
                };
                
                // ใช้ Dynamic Programming แบบง่าย - Knapsack Problem
                const tripOption = findBestCombination(
                    remainingOrders, 
                    vehicle.maxCBM, 
                    vehicle.maxWeight,
                    vehicle.maxDestinations,
                    vehicle.maxDistance
                );
                
                if (tripOption.length > 0) {
                    const totalCBM = tripOption.reduce((sum, o) => sum + o.cbm, 0);
                    const utilization = (totalCBM / vehicle.maxCBM) * 100;
                    
                    // เลือกทริปที่มี utilization สูงสุด
                    if (utilization > bestUtilization) {
                        bestUtilization = utilization;
                        bestTripOption = tripOption;
                        bestVehicle = vehicle;
                    }
                }
            }
            
            // ถ้าหาทริปที่ดีได้
            if (bestTripOption && bestTripOption.length > 0) {
                // ลบออเดอร์ที่จัดแล้วออกจาก remainingOrders
                bestTripOption.forEach(order => {
                    const index = remainingOrders.findIndex(o => o.id === order.id);
                    if (index !== -1) {
                        remainingOrders.splice(index, 1);
                    }
                });
                
                // คำนวณระยะทางรวม
                let totalDistance = 0;
                let lastLocation = DEPOT_LOCATION;
                
                // เรียงลำดับตามเวลาเปิด
                bestTripOption.sort((a, b) => {
                    const timeA = a.openTime ? parseInt(a.openTime.replace(':', '')) : 0;
                    const timeB = b.openTime ? parseInt(b.openTime.replace(':', '')) : 0;
                    return timeA - timeB;
                });
                
                bestTripOption.forEach(order => {
                    totalDistance += calculateDistance(
                        lastLocation.lat, lastLocation.lng,
                        order.lat, order.lng
                    );
                    lastLocation = { lat: order.lat, lng: order.lng };
                });
                
                // เพิ่มระยะทางกลับคลัง
                totalDistance += calculateDistance(
                    lastLocation.lat, lastLocation.lng,
                    DEPOT_LOCATION.lat, DEPOT_LOCATION.lng
                );
                
                const tripId = `TRIP${String(tripCounter).padStart(3, '0')}`;
                
                const trip = {
                    id: tripId,
                    type: bestVehicle.code,
                    branches: bestTripOption.length,
                    weight: bestTripOption.reduce((sum, o) => sum + o.weight, 0),
                    cbm: bestTripOption.reduce((sum, o) => sum + o.cbm, 0),
                    utilization: Math.round(bestUtilization),
                    cost: totalDistance * bestVehicle.costPerKm,
                    distance: Math.round(totalDistance),
                    estimatedTime: Math.round(totalDistance / 40 * 60),
                    branchList: bestTripOption.map(order => ({
                        name: order.branch,
                        weight: order.weight,
                        cbm: order.cbm,
                        address: order.address,
                        windowTime: `${order.openTime} - ${order.closeTime}`,
                        unloadTime: order.unloadTime || 30,
                        isSplit: order.isSplit || false
                    })),
                    locations: [
                        DEPOT_LOCATION,
                        ...bestTripOption.map(order => ({
                            lat: order.lat,
                            lng: order.lng,
                            name: order.branch
                        })),
                        DEPOT_LOCATION
                    ],
                    driver: null,
                    cluster: clusterName,
                    province: extractProvince(clusterOrders[0].address),
                    vehicleInfo: bestVehicle
                };
                
                allTrips.push(trip);
                tripCounter++;
                
                console.log(`✅ สร้าง ${tripId} - รถ ${bestVehicle.code} - ${bestTripOption.length} สาขา - Utilization: ${Math.round(bestUtilization)}%`);
            } else {
                // ถ้าไม่สามารถจัดได้เลย แสดงว่ามีปัญหา
                console.error('❌ ไม่สามารถจัดออเดอร์ที่เหลือได้:', remainingOrders);
                unassignedOrders.push(...remainingOrders);
                break;
            }
        }
    }
    
    // ตรวจสอบว่ามีออเดอร์ที่ไม่ได้จัดส่งหรือไม่
    // ตรวจสอบว่ามีออเดอร์ที่ไม่ได้จัดส่งหรือไม่
if (unassignedOrders.length > 0) {
    console.error('⚠️ มีออเดอร์ที่ไม่สามารถจัดส่งได้:', unassignedOrders.length, 'รายการ');
    
    // Force split สำหรับออเดอร์ที่เหลือ
    console.log('🔧 พยายามแบ่งออเดอร์ที่เหลือ...');
    
    // หารถที่ใหญ่ที่สุด
    const largestVehicle = {
        code: 'EMERGENCY',
        maxWeight: 5000,
        maxCBM: 20,
        maxDestinations: 10,
        maxDistance: 300,
        costPerKm: 20
    };
    
    // สร้างทริปฉุกเฉิน
    unassignedOrders.forEach(order => {
        const emergencyTrip = {
            id: `TRIP${String(tripCounter).padStart(3, '0')}`,
            type: '6W-พิเศษ',
            branches: 1,
            weight: order.weight,
            cbm: order.cbm,
            utilization: 50,
            cost: 1000,
            distance: 100,
            estimatedTime: 120,
            branchList: [{
                name: order.branch,
                weight: order.weight,
                cbm: order.cbm,
                address: order.address,
                windowTime: `${order.openTime} - ${order.closeTime}`,
                unloadTime: order.unloadTime || 30,
                isSplit: false
            }],
            locations: [
                DEPOT_LOCATION,
                { lat: order.lat, lng: order.lng, name: order.branch },
                DEPOT_LOCATION
            ],
            driver: null,
            cluster: 'ออเดอร์พิเศษ',
            province: extractProvince(order.address),
            vehicleInfo: largestVehicle
        };
        
        allTrips.push(emergencyTrip);
        tripCounter++;
    });
    
    // เคลียร์ unassignedOrders
    unassignedOrders = [];
    
    showNotification(
        `✅ จัดออเดอร์พิเศษเพิ่มเติมสำเร็จ!`,
        'success'
    );
}
    
    // เรียงลำดับทริปตาม utilization (สูงไปต่ำ)
    allTrips.sort((a, b) => b.utilization - a.utilization);
    
    console.log(`\n=== สรุป ===`);
    console.log(`ทริปทั้งหมด: ${allTrips.length}`);
    console.log(`Utilization เฉลี่ย: ${allTrips.length > 0 ? (allTrips.reduce((sum, t) => sum + t.utilization, 0) / allTrips.length).toFixed(1) : 0}%`);
    
    return allTrips;
}
        
        // Analysis Functions
        function showCBMAnalysis() {
    if (trips.length === 0) {
        showNotification('ยังไม่มีทริปที่จะวิเคราะห์ CBM', 'error');
        return;
    }
    
    // สร้าง modal แสดงรายละเอียด CBM
    const modalHTML = `
        <div class="modal-backdrop" id="cbmAnalysisModal">
            <div class="modal animate-fade-in" style="max-width: 600px;">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-3 rounded-xl">
                            <span class="text-2xl text-white">📊</span>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">วิเคราะห์ CBM ทั้งหมด</h3>
                    </div>
                    <button onclick="document.getElementById('cbmAnalysisModal').remove()" 
                            class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg">
                        ✕
                    </button>
                </div>
                
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    ${trips.map((trip, index) => {
                        const color = state.tripColors[index % state.tripColors.length];
                        const utilizationColor = trip.utilization >= 90 ? '#10b981' : 
                                               trip.utilization >= 70 ? '#f59e0b' : '#ef4444';
                        
                        return `
                            <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200 hover:shadow-md transition-all">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                                        <h4 class="font-bold text-lg">${trip.id}</h4>
                                        <span class="bg-gray-200 px-2 py-1 rounded text-sm">${trip.type}</span>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-bold" style="color: ${utilizationColor}">
                                            ${Math.round(trip.utilization)}%
                                        </p>
                                        <p class="text-xs text-gray-500">การใช้ประโยชน์</p>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="bg-white rounded-lg p-3 text-center">
                                        <p class="text-lg font-bold text-blue-600">${trip.cbm.toFixed(1)}</p>
                                        <p class="text-xs text-gray-500">CBM ใช้ไป</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 text-center">
                                        <p class="text-lg font-bold text-green-600">${trip.branches}</p>
                                        <p class="text-xs text-gray-500">จำนวนสาขา</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 text-center">
                                        <p class="text-lg font-bold text-purple-600">${trip.weight.toLocaleString()}</p>
                                        <p class="text-xs text-gray-500">น้ำหนัก (kg)</p>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-500" 
                                             style="width: ${trip.utilization}%; background-color: ${utilizationColor}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">CBM รวมทั้งหมด</p>
                            <p class="text-2xl font-bold text-blue-700">
                                ${trips.reduce((sum, trip) => sum + trip.cbm, 0).toFixed(1)} CBM
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">ประสิทธิภาพเฉลี่ย</p>
                            <p class="text-2xl font-bold text-green-700">
                                ${trips.length > 0 ? (trips.reduce((sum, trip) => sum + trip.utilization, 0) / trips.length).toFixed(1) : '0'}%
                            </p>
                        </div>
                    </div>
                </div>
                
                <button onclick="document.getElementById('cbmAnalysisModal').remove()" 
                        class="w-full btn btn-primary mt-4">
                    ปิด
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
        
        function showDistanceAnalysis() {
    if (trips.length === 0) {
        showNotification('ยังไม่มีทริปที่จะวิเคราะห์ระยะทาง', 'error');
        return;
    }
    
    const totalDistance = trips.reduce((sum, trip) => sum + trip.distance, 0);
    const avgDistance = trips.length > 0 ? totalDistance / trips.length : 0;
    const longestTrip = trips.reduce((max, trip) => trip.distance > max.distance ? trip : max, trips[0]);
    const shortestTrip = trips.reduce((min, trip) => trip.distance < min.distance ? trip : min, trips[0]);
    
    const modalHTML = `
        <div class="modal-backdrop" id="distanceAnalysisModal">
            <div class="modal animate-fade-in" style="max-width: 600px;">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-3 rounded-xl">
                            <span class="text-2xl text-white">📍</span>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">วิเคราะห์ระยะทาง</h3>
                    </div>
                    <button onclick="document.getElementById('distanceAnalysisModal').remove()" 
                            class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-100 rounded-lg">
                        ✕
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                        <span class="text-3xl mb-2">🛣️</span>
                        <p class="text-sm text-gray-600">ระยะทางรวม</p>
                        <p class="text-3xl font-bold text-purple-700">${totalDistance.toFixed(1)}</p>
                        <p class="text-sm text-purple-600">กิโลเมตร</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center">
                        <span class="text-3xl mb-2">📊</span>
                        <p class="text-sm text-gray-600">ระยะทางเฉลี่ย</p>
                        <p class="text-3xl font-bold text-blue-700">${avgDistance.toFixed(1)}</p>
                        <p class="text-sm text-blue-600">กม./ทริป</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-green-50 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">ทริปที่สั้นที่สุด</p>
                                <p class="font-bold text-green-700">${shortestTrip.id}</p>
                            </div>
                            <p class="text-2xl font-bold text-green-600">${shortestTrip.distance} กม.</p>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">ทริปที่ไกลที่สุด</p>
                                <p class="font-bold text-red-700">${longestTrip.id}</p>
                            </div>
                            <p class="text-2xl font-bold text-red-600">${longestTrip.distance} กม.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 space-y-3 max-h-64 overflow-y-auto">
                    ${trips.map((trip, index) => {
                        const color = state.tripColors[index % state.tripColors.length];
                        const percentage = totalDistance > 0 ? (trip.distance / totalDistance * 100) : 0;
                        
                        return `
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                                <span class="font-medium text-sm w-20">${trip.id}</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-6 relative overflow-hidden">
                                    <div class="h-full rounded-full flex items-center justify-end pr-2" 
                                         style="width: ${percentage}%; background-color: ${color}">
                                        <span class="text-xs text-white font-bold">${trip.distance} กม.</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <button onclick="document.getElementById('distanceAnalysisModal').remove()" 
                        class="w-full btn btn-primary mt-4">
                    ปิด
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
        
        // Trip Management Functions
        function filterTrips() {
            const selectedType = document.getElementById('vehicleTypeFilter').value;
            
            if (!selectedType) {
                renderTripCards();
                return;
            }
            
            const filteredTrips = trips.filter(trip => trip.type === selectedType);
            const container = document.getElementById('tripCardsContainer');
            
            if (filteredTrips.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <svg class="icon-xl mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>ไม่พบทริปสำหรับประเภทรถ ${selectedType}</p>
                    </div>
                `;
            } else {
                container.innerHTML = filteredTrips.map((trip, index) => createTripCardHTML(trip, index)).join('');
                initializeDriverSearch();
            }
        }
        
        function filterTripsAndMap() {
    const selectedType = document.getElementById('vehicleTypeFilter').value;
    const cbmRange = document.getElementById('cbmRangeFilter').value;
    
    let filteredTrips = [...trips];
    
    // Filter by vehicle type
    if (selectedType && selectedType !== '') {
        filteredTrips = filteredTrips.filter(trip => trip.type === selectedType);
    }
    
    // Filter by CBM range
    if (cbmRange && cbmRange !== 'ทุกช่วง CBM') {
        if (cbmRange === '0-10 CBM') {
            filteredTrips = filteredTrips.filter(trip => trip.cbm >= 0 && trip.cbm <= 10);
        } else if (cbmRange === '10-20 CBM') {
            filteredTrips = filteredTrips.filter(trip => trip.cbm > 10 && trip.cbm <= 20);
        } else if (cbmRange === '20-30 CBM') {
            filteredTrips = filteredTrips.filter(trip => trip.cbm > 20 && trip.cbm <= 30);
        } else if (cbmRange === '30+ CBM') {
            filteredTrips = filteredTrips.filter(trip => trip.cbm > 30);
        }
    }
    
    // Update visible trips for map
    state.visibleTrips = filteredTrips.map(t => t.id);
    
    // Redraw map with filtered trips
    if (state.map) {
        drawOptimizedRoutes();
    }
    
    // Update trip cards
    const container = document.getElementById('tripCardsContainer');
    if (filteredTrips.length === 0) {
        container.innerHTML = `
            <div class="col-span-2 text-center py-8 text-gray-500">
                <svg class="icon-xl mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p>ไม่พบทริปที่ตรงกับเงื่อนไขการค้นหา</p>
            </div>
        `;
    } else {
        container.innerHTML = filteredTrips.map((trip, index) => {
            const originalIndex = trips.indexOf(trip);
            return createTripCardHTML(trip, originalIndex);
        }).join('');
        initializeDriverSearch();
    }
    
    // Update statistics for filtered trips
    updateFilteredStatistics(filteredTrips);
}

        
        function updateFilteredStatistics(filteredTrips) {
    const container = document.getElementById('statisticsCards');
    if (!container) return;
    
    const stats = [
        { 
            title: 'จำนวนทริปที่แสดง', 
            value: filteredTrips.length, 
            color: 'green', 
            icon: '🚛' 
        },
        { 
            title: 'การใช้ประโยชน์เฉลี่ย', 
            value: filteredTrips.length > 0 ? 
                (filteredTrips.reduce((sum, trip) => sum + trip.utilization, 0) / filteredTrips.length).toFixed(1) + '%' : 
                '0%', 
            color: 'blue', 
            icon: '📊' 
        },
        { 
            title: 'CBM รวม', 
            value: filteredTrips.reduce((sum, trip) => sum + trip.cbm, 0).toFixed(1), 
            color: 'orange', 
            icon: '📦' 
        },
        { 
            title: 'ระยะทางรวม (กม.)', 
            value: filteredTrips.reduce((sum, trip) => sum + trip.distance, 0).toFixed(1), 
            color: 'purple', 
            icon: '📍' 
        },
        { 
            title: 'สาขารวม', 
            value: filteredTrips.reduce((sum, trip) => sum + trip.branches, 0), 
            color: 'yellow', 
            icon: '🏪' 
        },
        { 
            title: 'น้ำหนักรวม (ตัน)', 
            value: (filteredTrips.reduce((sum, trip) => sum + trip.weight, 0) / 1000).toFixed(1), 
            color: 'indigo', 
            icon: '⚖️' 
        }
    ];
    
    container.innerHTML = stats.map(stat => `
        <div class="bg-gradient-to-br from-${stat.color}-50 to-${stat.color}-100 rounded-xl p-4 border border-${stat.color}-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">${stat.title}</p>
                    <p class="text-2xl font-bold text-${stat.color}-700 mt-1">${stat.value}</p>
                </div>
                <span class="text-3xl">${stat.icon}</span>
            </div>
        </div>
    `).join('');
}
        
        function updateTripFilterList() {
            const container = document.getElementById('tripFilterList');
            if (!container || trips.length === 0) return;
            
            container.innerHTML = trips.map((trip, index) => `
                <div class="trip-checkbox">
                    <input type="checkbox" 
                           id="trip-filter-${trip.id}" 
                           value="${trip.id}" 
                           checked
                           onchange="filterMapTrips()">
                    <label for="trip-filter-${trip.id}">
                        <span class="trip-color-indicator" 
                              style="background-color: ${state.tripColors[index % state.tripColors.length]}">
                        </span>
                        ${trip.id}
                    </label>
                </div>
            `).join('');
        }
        
        function filterMapTrips() {
            const checkedTrips = Array.from(document.querySelectorAll('#tripFilterList input:checked'))
                .map(input => input.value);
            
            state.visibleTrips = checkedTrips;
            drawOptimizedRoutes();
        }
        
        function checkConfirmButtonVisibility() {
            const confirmSection = document.getElementById('confirmPlanSection');
            const allTripsHaveDrivers = trips.length > 0 && trips.every(trip => trip.driver);
            
            if (allTripsHaveDrivers) {
                confirmSection.classList.remove('hidden');
            } else {
                confirmSection.classList.add('hidden');
            }
        }
        
        function confirmPlan() {
            if (trips.length === 0) {
                showNotification('ไม่มีแผนการจัดส่งที่จะยืนยัน', 'error');
                return;
            }
            
            const tripsWithoutDrivers = trips.filter(trip => !trip.driver);
            if (tripsWithoutDrivers.length > 0) {
                showNotification(`กรุณากำหนดคนขับให้ครบทุกทริป (เหลือ ${tripsWithoutDrivers.length} ทริป)`, 'error');
                return;
            }
            
            const historyEntry = {
                id: `HIST${String(deliveryHistory.length + 1).padStart(4, '0')}`,
                date: new Date().toISOString().substring(0, 10),
                trips: trips.length,
                orders: trips.reduce((sum, trip) => sum + trip.branches, 0),
                totalWeight: trips.reduce((sum, trip) => sum + trip.weight, 0),
                totalCBM: trips.reduce((sum, trip) => sum + trip.cbm, 0),
                totalCost: trips.reduce((sum, trip) => sum + trip.cost, 0),
                status: 'เสร็จสิ้น',
                tripDetails: trips.map(trip => ({
                    ...trip,
                    confirmedAt: new Date().toISOString()
                }))
            };
            
            deliveryHistory.push(historyEntry);
            persistDeliveryHistory();
            
            trips = [];
            persistTrips();
            
            orders.forEach(order => {
                if (order.status === 'วางแผนแล้ว') {
                    order.status = 'จัดส่งแล้ว';
                }
            });
            persistOrders();
            
            showNotification('ยืนยันแผนการจัดส่งเรียบร้อยแล้ว! ข้อมูลถูกบันทึกในประวัติการจัดส่ง', 'success');
            
            renderTripCards();
            renderStatisticsCards();
            checkConfirmButtonVisibility();
            
            if (state.map) {
                state.markers.forEach(marker => marker.setMap(null));
                state.markers = [];
                state.branchMarkers = {};
            }
            
            setTimeout(() => {
                switchTab('history');
            }, 1500);
        }
        
        // Driver Functions
        function initializeDriverSearch() {
            // Initialize all driver search inputs
            document.querySelectorAll('.driver-search-container').forEach(container => {
                const input = container.querySelector('.driver-search-input');
                const dropdown = container.querySelector('.driver-search-dropdown');
                const tripId = input.dataset.tripId;
                
                input.addEventListener('input', (e) => {
                    filterDriversDropdown(tripId, e.target.value);
                });
                
                input.addEventListener('focus', () => {
                    dropdown.classList.remove('hidden');
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        }
        
        function filterDriversDropdown(tripId, searchTerm) {
            const dropdown = document.getElementById(`driverDropdown-${tripId}`);
            const trip = trips.find(t => t.id === tripId);
            
            if (!trip || !dropdown) return;
            
            const filteredDrivers = drivers.filter(driver => 
                driver.vehicleTypes.some(vt => vt === trip.type || vt.includes(trip.type)) &&
                driver.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            dropdown.innerHTML = filteredDrivers.map(driver => `
                <div class="driver-search-item" onclick="selectDriver('${tripId}', '${driver.id}')">
                    ${driver.name} - ${driver.phone}
                </div>
            `).join('');
            
            if (filteredDrivers.length === 0) {
                dropdown.innerHTML = '<div class="driver-search-item text-gray-500">ไม่พบคนขับที่ตรงกับการค้นหา</div>';
            }
        }
        
        function selectDriver(tripId, driverId) {
            const driver = drivers.find(d => d.id === driverId);
            const trip = trips.find(t => t.id === tripId);
            
            if (trip && driver) {
                trip.driver = driver.name;
                trip.driverId = driverId;
                
                // Update the input field
                const input = document.querySelector(`[data-trip-id="${tripId}"]`);
                if (input) {
                    input.value = driver.name;
                }
                
                // Hide dropdown
                const dropdown = document.getElementById(`driverDropdown-${tripId}`);
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
                
                showNotification(`กำหนด ${driver.name} สำหรับ ${tripId} แล้ว`, 'success');
                persistTrips();
                renderTripCards();
                checkConfirmButtonVisibility();
            }
        }
        
        function changeDriver(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.driver = null;
                trip.driverId = null;
                persistTrips();
                renderTripCards();
                checkConfirmButtonVisibility();
                showNotification('ลบคนขับเรียบร้อยแล้ว กรุณาเลือกคนขับใหม่', 'info');
            }
        }
        
        // Drag and Drop Functions
        function handleSingleClickDrag(branchName, fromTripId) {
            const branch = trips.find(t => t.id === fromTripId)?.branchList.find(b => b.name === branchName);
            if (!branch) return;
            
            if (state.selectedForDrag && 
                state.selectedForDrag.branch.name === branchName && 
                state.selectedForDrag.fromTripId === fromTripId) {
                state.selectedForDrag = null;
            } else {
                state.selectedForDrag = { branch, fromTripId };
            }
            renderTripCards();
        }
        
        function handleTripClickDrop(targetTripId) {
            if (state.selectedForDrag && state.selectedForDrag.fromTripId !== targetTripId) {
                state.dropTarget = { 
                    targetTripId, 
                    targetIndex: null, 
                    branch: state.selectedForDrag.branch, 
                    fromTripId: state.selectedForDrag.fromTripId 
                };
                showDropConfirmModal();
            }
        }
        
        function showDropConfirmModal() {
    if (!state.dropTarget) return;
    
    const { branch, fromTripId, targetTripId } = state.dropTarget;
    const sourceTrip = trips.find(t => t.id === fromTripId);
    const targetTrip = trips.find(t => t.id === targetTripId);
    
    document.getElementById('dropConfirmContent').innerHTML = `
        <div class="text-center mb-6">
            <div class="mx-auto bg-gradient-to-br from-blue-100 to-purple-100 rounded-full p-6 w-24 h-24 flex items-center justify-center mb-4">
                <span class="text-5xl">📦</span>
            </div>
            <h4 class="text-xl font-bold text-gray-800 mb-2">กำลังย้ายสาขา</h4>
            <p class="text-2xl font-bold text-blue-600">${branch.name}</p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- จากทริป -->
            <div class="relative">
                <div class="absolute -top-3 left-3 bg-white px-2">
                    <span class="text-xs text-gray-500 font-medium">จากทริป</span>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 border-2 border-red-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">🚛</span>
                        <span class="font-bold text-lg text-red-700">${fromTripId}</span>
                    </div>
                    ${sourceTrip ? `
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">สาขาคงเหลือ:</span>
                                <span class="font-medium text-red-600">${sourceTrip.branches - 1} สาขา</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">น้ำหนักใหม่:</span>
                                <span class="font-medium">${(sourceTrip.weight - branch.weight).toLocaleString()} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">CBM ใหม่:</span>
                                <span class="font-medium">${(sourceTrip.cbm - branch.cbm).toFixed(1)}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- ไปยังทริป -->
            <div class="relative">
                <div class="absolute -top-3 left-3 bg-white px-2">
                    <span class="text-xs text-gray-500 font-medium">ไปยังทริป</span>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border-2 border-green-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-2xl">🚚</span>
                        <span class="font-bold text-lg text-green-700">${targetTripId}</span>
                    </div>
                    ${targetTrip ? `
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">สาขาทั้งหมด:</span>
                                <span class="font-medium text-green-600">${targetTrip.branches + 1} สาขา</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">น้ำหนักใหม่:</span>
                                <span class="font-medium">${(targetTrip.weight + branch.weight).toLocaleString()} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">CBM ใหม่:</span>
                                <span class="font-medium">${(targetTrip.cbm + branch.cbm).toFixed(1)}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <!-- ข้อมูลสาขาที่ย้าย -->
        <div class="bg-gray-50 rounded-xl p-4 mb-6">
            <p class="text-xs text-gray-500 mb-2">รายละเอียดสาขาที่ย้าย</p>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="text-blue-500">⚖️</span>
                    <span>น้ำหนัก: <strong>${branch.weight.toLocaleString()} kg</strong></span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-orange-500">📦</span>
                    <span>ปริมาตร: <strong>${branch.cbm} CBM</strong></span>
                </div>
            </div>
            ${branch.windowTime ? `
                <div class="mt-2 flex items-center gap-2 text-sm">
                    <span class="text-green-500">⏰</span>
                    <span>เวลาทำการ: <strong>${branch.windowTime}</strong></span>
                </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('dropConfirmModal').classList.remove('hidden');
}
        
        function confirmDrop() {
            if (state.dropTarget) {
                const { branch, fromTripId, targetTripId, targetIndex } = state.dropTarget;
                
                const sourceTrip = trips.find(t => t.id === fromTripId);
                const targetTrip = trips.find(t => t.id === targetTripId);
                
                if (sourceTrip && targetTrip) {
                    const branchIndex = sourceTrip.branchList.findIndex(b => b.name === branch.name);
                    if (branchIndex !== -1) {
                        // Remove from source trip
                        sourceTrip.branchList.splice(branchIndex, 1);
                        sourceTrip.branches = sourceTrip.branchList.length;
                        sourceTrip.weight = sourceTrip.branchList.reduce((sum, b) => sum + b.weight, 0);
                        sourceTrip.cbm = sourceTrip.branchList.reduce((sum, b) => sum + b.cbm, 0);
                        
                        // Update utilization
                        const vehicleCapacities = {
                            '4W': { maxCBM: 10 },
                            '4WJ': { maxCBM: 15 },
                            '6W': { maxCBM: 20 },
                            '10W': { maxCBM: 40 },
                            'COOL4W': { maxCBM: 9 },
                            'COOL6W': { maxCBM: 18 },
                            'OIL': { maxCBM: 30 }
                        };
                        
                        sourceTrip.utilization = sourceTrip.branches > 0 
                            ? Math.min(95, (sourceTrip.cbm / vehicleCapacities[sourceTrip.type].maxCBM) * 100)
                            : 0;
                        
                        sourceTrip.locations = sourceTrip.locations.filter(loc => loc.name !== branch.name);
                        
                        // Remove trip if empty
                        if (sourceTrip.branches === 0) {
                            const sourceTripIndex = trips.findIndex(t => t.id === fromTripId);
                            if (sourceTripIndex !== -1) {
                                trips.splice(sourceTripIndex, 1);
                            }
                        }
                        
                        // Add to target trip
                        if (targetIndex !== null && targetIndex !== undefined) {
                            targetTrip.branchList.splice(targetIndex, 0, branch);
                        } else {
                            targetTrip.branchList.push(branch);
                        }
                        targetTrip.branches = targetTrip.branchList.length;
                        targetTrip.weight = targetTrip.branchList.reduce((sum, b) => sum + b.weight, 0);
                        targetTrip.cbm = targetTrip.branchList.reduce((sum, b) => sum + b.cbm, 0);
                        targetTrip.utilization = Math.min(95, (targetTrip.cbm / vehicleCapacities[targetTrip.type].maxCBM) * 100);
                        
                        // Add location
                        const branchOrder = orders.find(o => o.branch === branch.name);
                        if (branchOrder) {
                            targetTrip.locations.push({
                                lat: branchOrder.lat,
                                lng: branchOrder.lng,
                                name: branch.name
                            });
                        }
                        
                        persistTrips();
                        showNotification(`ย้าย ${branch.name} จาก ${fromTripId} ไปยัง ${targetTripId} สำเร็จ`, 'success');
                        renderTripCards();
                        renderStatisticsCards();
                        
                        // Recalculate routes and distances
                        drawOptimizedRoutes();
                    }
                }
                
                cancelDrop();
            }
        }
        
        function cancelDrop() {
            document.getElementById('dropConfirmModal').classList.add('hidden');
            state.dropTarget = null;
            state.selectedForDrag = null;
            state.selectedMapBranch = null;
            clearMapSelection();
            closeMapPopup();
            renderTripCards();
        }
        
        function removeBranch(tripId, branchIndex) {
            const trip = trips.find(t => t.id === tripId);
            if (trip && confirm(`ต้องการลบสาขา ${trip.branchList[branchIndex].name} ออกจากทริปนี้?`)) {
                const removedBranch = trip.branchList[branchIndex];
                trip.branchList.splice(branchIndex, 1);
                trip.branches = trip.branchList.length;
                trip.weight = trip.branchList.reduce((sum, b) => sum + b.weight, 0);
                trip.cbm = trip.branchList.reduce((sum, b) => sum + b.cbm, 0);
                
                // Update locations
                trip.locations = trip.locations.filter(loc => loc.name !== removedBranch.name);
                
                if (trip.branches === 0) {
                    const tripIndex = trips.findIndex(t => t.id === tripId);
                    if (tripIndex !== -1) {
                        trips.splice(tripIndex, 1);
                    }
                } else {
                    // Update utilization
                    const vehicleCapacities = {
                        '4W': { maxCBM: 10 },
                        '4WJ': { maxCBM: 15 },
                        '6W': { maxCBM: 20 },
                        '10W': { maxCBM: 40 },
                        'COOL4W': { maxCBM: 9 },
                        'COOL6W': { maxCBM: 18 },
                        'OIL': { maxCBM: 30 }
                    };
                    trip.utilization = Math.min(95, (trip.cbm / vehicleCapacities[trip.type].maxCBM) * 100);
                }
                
                persistTrips();
                renderTripCards();
                renderStatisticsCards();
                
                // Recalculate routes and distances
                drawOptimizedRoutes();
                showNotification(`ลบสาขา ${removedBranch.name} เรียบร้อยแล้ว`, 'success');
            }
        }
        
        // Modal Functions
        function showAddVehicleForm() {
            document.getElementById('addVehicleModal').classList.remove('hidden');
            renderVehicleCategoryButtons();
        }
        
        function hideAddVehicleForm() {
            document.getElementById('addVehicleModal').classList.add('hidden');
            document.getElementById('addVehicleForm').reset();
            state.selectedVehicleCategory = '';
        }
        
        function renderVehicleCategoryButtons() {
            const container = document.getElementById('vehicleCategorySelect');
            container.innerHTML = vehicleCategories.map((cat, idx) => `
                <button type="button"
                        onclick="selectVehicleCategory('${cat.name}')"
                        class="p-3 rounded-lg border-2 transition-all ${
                            state.selectedVehicleCategory === cat.name 
                                ? 'border-teal-500 bg-teal-50' 
                                : 'border-gray-200 hover:border-gray-300'
                        }" style="${state.selectedVehicleCategory === cat.name ? 'border-color: #20B2AA; background-color: rgba(32,178,170,0.1);' : ''}">
                    <div class="text-2xl mb-1">${cat.icon}</div>
                    <p class="text-xs font-medium">${cat.name}</p>
                </button>
            `).join('');
        }
        
        function selectVehicleCategory(category) {
            state.selectedVehicleCategory = category;
            renderVehicleCategoryButtons();
        }
        // Vehicle Edit/Delete Functions
function editVehicle(vehicleId) {
    const vehicle = vehicleTypes.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    // สร้าง edit modal
    const modalHTML = `
        <div class="modal-backdrop" id="editVehicleModal">
            <div class="modal">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-3 rounded-xl">
                        <svg class="icon-lg text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">แก้ไขประเภทรถ</h3>
                </div>
                
                <form id="editVehicleForm" onsubmit="saveVehicleEdit(event, '${vehicleId}')">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">รหัสรถ</label>
                            <input type="text" name="code" class="input" value="${vehicle.code}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อประเภทรถ</label>
                            <input type="text" name="name" class="input" value="${vehicle.name}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">น้ำหนักสูงสุด (kg)</label>
                            <input type="number" name="maxWeight" class="input" value="${vehicle.maxWeight}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ปริมาตร (CBM)</label>
                            <input type="number" name="maxCBM" class="input" value="${vehicle.maxCBM}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">จุดส่งสูงสุด</label>
                            <input type="number" name="maxDestinations" class="input" value="${vehicle.maxDestinations}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ระยะทางวิ่งสูงสุด (กม.)</label>
                            <input type="number" name="maxDistance" class="input" value="${vehicle.maxDistance || ''}" required>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ต้นทุนต่อกิโลเมตร (บาท)</label>
                            <input type="number" name="costPerKm" step="0.01" class="input" value="${vehicle.costPerKm}" required>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-8">
                        <button type="submit" class="flex-1 btn btn-primary">บันทึกการแก้ไข</button>
                        <button type="button" onclick="document.getElementById('editVehicleModal').remove()" 
                                class="flex-1 btn btn-secondary">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
function saveVehicleEdit(event, vehicleId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const vehicleIndex = vehicleTypes.findIndex(v => v.id === vehicleId);
    
    if (vehicleIndex !== -1) {
        vehicleTypes[vehicleIndex] = {
            ...vehicleTypes[vehicleIndex],
            code: formData.get('code'),
            name: formData.get('name'),
            maxWeight: parseInt(formData.get('maxWeight')),
            maxCBM: parseInt(formData.get('maxCBM')),
            maxDestinations: parseInt(formData.get('maxDestinations')),
            maxDistance: parseInt(formData.get('maxDistance')),
            costPerKm: parseFloat(formData.get('costPerKm'))
        };
        
        saveToStorage('driver_adz_vehicles', vehicleTypes);
        document.getElementById('editVehicleModal').remove();
        showNotification('แก้ไขข้อมูลประเภทรถสำเร็จ', 'success');
        renderVehicleTypesTable();
        updateVehicleTypeFilter();
    }
}
function deleteVehicle(vehicleId) {
    const vehicle = vehicleTypes.find(v => v.id === vehicleId);
    if (!vehicle) return;
    
    // สร้าง confirmation modal ที่สวยงาม
    const modalHTML = `
        <div class="modal-backdrop" id="deleteVehicleModal">
            <div class="modal" style="max-width: 400px;">
                <div class="text-center">
                    <div class="mx-auto bg-red-100 rounded-full p-4 w-20 h-20 flex items-center justify-center mb-4">
                        <span class="text-4xl">🗑️</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">ยืนยันการลบ</h3>
                    <p class="text-gray-600 mb-6">
                        คุณต้องการลบประเภทรถ <strong>${vehicle.code} - ${vehicle.name}</strong> หรือไม่?
                    </p>
                    <p class="text-sm text-red-600 mb-6">
                        ⚠️ การดำเนินการนี้ไม่สามารถย้อนกลับได้
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="confirmDeleteVehicle('${vehicleId}')" 
                            class="flex-1 btn btn-danger">
                        ใช่, ลบเลย
                    </button>
                    <button onclick="document.getElementById('deleteVehicleModal').remove()" 
                            class="flex-1 btn btn-secondary">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
function confirmDeleteVehicle(vehicleId) {
    const vehicleIndex = vehicleTypes.findIndex(v => v.id === vehicleId);
    if (vehicleIndex !== -1) {
        vehicleTypes.splice(vehicleIndex, 1);
        saveToStorage('driver_adz_vehicles', vehicleTypes);
        document.getElementById('deleteVehicleModal').remove();
        showNotification('ลบประเภทรถสำเร็จ', 'success');
        renderVehicleTypesTable();
        updateVehicleTypeFilter();
    }
}
        // Driver Edit/Delete Functions
function editDriver(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;
    
    const modalHTML = `
        <div class="modal-backdrop" id="editDriverModal">
            <div class="modal" style="max-width: 48rem; max-height: 90vh; overflow-y: auto;">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-3 rounded-xl">
                        <svg class="icon-lg text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">แก้ไขข้อมูลคนขับ</h3>
                </div>
                
                <form id="editDriverForm" onsubmit="saveDriverEdit(event, '${driverId}')">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                            <input type="text" name="name" class="input" value="${driver.name}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทรศัพท์</label>
                            <input type="tel" name="phone" class="input" value="${driver.phone}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทใบขับขี่</label>
                            <select name="licenseType" class="select" required>
                                <option value="ท.1" ${driver.licenseType === 'ท.1' ? 'selected' : ''}>ท.1</option>
                                <option value="ท.2" ${driver.licenseType === 'ท.2' ? 'selected' : ''}>ท.2</option>
                                <option value="ท.3" ${driver.licenseType === 'ท.3' ? 'selected' : ''}>ท.3</option>
                                <option value="ท.4" ${driver.licenseType === 'ท.4' ? 'selected' : ''}>ท.4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">เลขใบขับขี่</label>
                            <input type="text" name="licenseNo" class="input" value="${driver.licenseNo}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันหมดอายุใบขับขี่</label>
                            <input type="date" name="licenseExpiry" class="input" value="${driver.licenseExpiry}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">พื้นที่รับผิดชอบ</label>
                            <input type="text" name="area" class="input" value="${driver.area}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">บริษัทต้นสังกัด</label>
                            <input type="text" name="company" class="input" value="${driver.company}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทรถที่ขับได้</label>
                            <div class="flex flex-wrap gap-2" id="editVehicleTypesCheckboxes">
                                ${['4W', '4WJ', '6W', '10W', 'COOL4W', 'COOL6W', 'OIL'].map(type => `
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="vehicleTypes" value="${type}" 
                                               ${driver.vehicleTypes.includes(type) ? 'checked' : ''}>
                                        <span class="text-sm">${type}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-8">
                        <button type="submit" class="flex-1 btn btn-primary">บันทึกการแก้ไข</button>
                        <button type="button" onclick="document.getElementById('editDriverModal').remove()" 
                                class="flex-1 btn btn-secondary">ยกเลิก</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
function saveDriverEdit(event, driverId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const driverIndex = drivers.findIndex(d => d.id === driverId);
    
    if (driverIndex !== -1) {
        const vehicleTypes = [];
        document.querySelectorAll('#editVehicleTypesCheckboxes input[name="vehicleTypes"]:checked').forEach(checkbox => {
            vehicleTypes.push(checkbox.value);
        });
        
        drivers[driverIndex] = {
            ...drivers[driverIndex],
            name: formData.get('name'),
            phone: formData.get('phone'),
            licenseType: formData.get('licenseType'),
            licenseNo: formData.get('licenseNo'),
            licenseExpiry: formData.get('licenseExpiry'),
            vehicleTypes: vehicleTypes,
            area: formData.get('area'),
            company: formData.get('company')
        };
        
        saveToStorage('driver_adz_drivers', drivers);
        document.getElementById('editDriverModal').remove();
        showNotification('แก้ไขข้อมูลคนขับสำเร็จ', 'success');
        renderDriversGrid();
    }
}
function deleteDriver(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;
    
    const modalHTML = `
        <div class="modal-backdrop" id="deleteDriverModal">
            <div class="modal" style="max-width: 400px;">
                <div class="text-center">
                    <div class="mx-auto bg-red-100 rounded-full p-4 w-20 h-20 flex items-center justify-center mb-4">
                        <span class="text-4xl">👤</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">ยืนยันการลบคนขับ</h3>
                    <p class="text-gray-600 mb-6">
                        คุณต้องการลบข้อมูลของ <strong>${driver.name}</strong> หรือไม่?
                    </p>
                    <p class="text-sm text-red-600 mb-6">
                        ⚠️ การดำเนินการนี้ไม่สามารถย้อนกลับได้
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="confirmDeleteDriver('${driverId}')" 
                            class="flex-1 btn btn-danger">
                        ใช่, ลบเลย
                    </button>
                    <button onclick="document.getElementById('deleteDriverModal').remove()" 
                            class="flex-1 btn btn-secondary">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
function confirmDeleteDriver(driverId) {
    const driverIndex = drivers.findIndex(d => d.id === driverId);
    if (driverIndex !== -1) {
        drivers.splice(driverIndex, 1);
        saveToStorage('driver_adz_drivers', drivers);
        document.getElementById('deleteDriverModal').remove();
        showNotification('ลบข้อมูลคนขับสำเร็จ', 'success');
        renderDriversGrid();
    }
}
        function showAddDriverForm() {
            document.getElementById('addDriverModal').classList.remove('hidden');
            renderVehicleTypeCheckboxes();
        }
        
        function hideAddDriverForm() {
            document.getElementById('addDriverModal').classList.add('hidden');
            document.getElementById('addDriverForm').reset();
        }
        
        function renderVehicleTypeCheckboxes() {
            const container = document.getElementById('vehicleTypesCheckboxes');
            const commonTypes = [
                { code: '4W', name: '4W' },
                { code: '4WJ', name: '4WJ' },
                { code: '6W', name: '6W' },
                { code: '10W', name: '10W' },
                { code: 'COOL4W', name: '❄️ 4W' },
                { code: 'COOL6W', name: '❄️ 6W' },
                { code: 'OIL', name: '⛽ รถน้ำมัน' }
            ];
            
            container.innerHTML = commonTypes.map(type => `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="vehicleTypes" value="${type.code}" class="w-4 h-4">
                    <span class="text-sm">${type.name}</span>
                </label>
            `).join('') + 
            vehicleTypes.filter(v => !commonTypes.find(ct => ct.code === v.code)).map(vehicle => `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="vehicleTypes" value="${vehicle.code}" class="w-4 h-4">
                    <span class="text-sm">${vehicle.code}</span>
                </label>
            `).join('');
        }
        
        // Success Modal Functions
        function updateSuccessModalData(optimizedTrips, aiInsights) {
            const totalTrips = optimizedTrips.length;
            const totalPoints = optimizedTrips.reduce((sum, trip) => sum + trip.branches, 0);
            const avgUtilization = optimizedTrips.length > 0 ? 
                (optimizedTrips.reduce((sum, trip) => sum + trip.utilization, 0) / optimizedTrips.length).toFixed(1) : 0;
            
            document.getElementById('totalTripsCount').textContent = totalTrips;
            document.getElementById('totalDeliveryPoints').textContent = totalPoints;
            document.getElementById('efficiencyPercentage').textContent = avgUtilization + '%';
            
            
        }
        
        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
        }
        
       function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    modal.classList.add('hidden');
}
        
        // Notification Functions
        function toggleNotifications() {
            state.showNotifications = !state.showNotifications;
            const dropdown = document.getElementById('notificationsDropdown');
            
            if (state.showNotifications) {
                dropdown.classList.remove('hidden');
                renderNotifications();
            } else {
                dropdown.classList.add('hidden');
            }
        }
        
        function refreshData() {
            showNotification('กำลังรีเฟรชข้อมูล...', 'info');
            setTimeout(() => {
                switchTab(state.activeTab);
                showNotification('รีเฟรชข้อมูลเรียบร้อยแล้ว', 'success');
            }, 1000);
        }
        
        // History Functions
        function filterToday() {
            const today = new Date().toISOString().substring(0, 10);
            document.getElementById('historyDate').value = today;
            filterHistory();
        }
        
        function filterHistory() {
            const selectedDate = document.getElementById('historyDate').value;
            renderHistoryGrid(selectedDate);
        }
        
        // Render Functions
        function renderOrdersTable(ordersToRender = orders) {
            const tbody = document.getElementById('ordersTableBody');
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            const paginatedOrders = ordersToRender.slice(startIndex, endIndex);
            
            tbody.innerHTML = paginatedOrders.map(order => `
                <tr>
                    <td>${order.branchCode || '-'}</td>
                    <td>${order.branch || '-'}</td>
                    <td title="${order.address}">${(order.address || '-').substring(0, 30)}${order.address && order.address.length > 30 ? '...' : ''}</td>
                    <td>${order.lat || '-'}</td>
                    <td>${order.lng || '-'}</td>
                    <td>${order.cbm || '-'}</td>
                    <td>${order.weight ? order.weight.toLocaleString() : '-'}</td>
                    <td>${order.pieces || '-'}</td>
                    <td>${order.workDate || '-'}</td>
                    <td>${order.openTime || '-'}</td>
                    <td>${order.closeTime || '-'}</td>
                    <td>${order.unloadTime || '-'}</td>
                    <td><span class="badge badge-blue">${order.vehicleType || '-'}</span></td>
                    <td>${order.contactName || '-'}</td>
                    <td>${order.contactPhone || '-'}</td>
                    <td>${order.location || '-'}</td>
                    <td><span class="badge badge-${order.status === 'วางแผนแล้ว' ? 'green' : order.status === 'จัดส่งแล้ว' ? 'blue' : 'yellow'}">${order.status}</span></td>
                    <td class="text-right">
                        <button onclick="editOrder('${order.id}')" class="text-teal-600 hover:text-teal-700 mr-3" style="color: #20B2AA;">
                            ✏️
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-700">
                            🗑️
                        </button>
                    </td>
                </tr>
            `).join('');
            
            renderOrdersPagination(ordersToRender.length);
        }
        
        function renderOrdersPagination(totalOrders) {
            const totalPages = Math.ceil(totalOrders / state.rowsPerPage);
            const pagination = document.getElementById('ordersPagination');
            
            if (!pagination) return;
            
            let html = `
                <button onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>
                    ก่อนหน้า
                </button>
            `;
            
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `
                    <button onclick="changePage(${i})" class="${state.currentPage === i ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            html += `
                <button onclick="changePage(${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''}>
                    ถัดไป
                </button>
                <span class="pagination-info">
                    หน้า ${state.currentPage} จาก ${totalPages} (${totalOrders} รายการ)
                </span>
            `;
            
            pagination.innerHTML = html;
        }
        
        function changePage(page) {
            if (page < 1) return;
            const totalPages = Math.ceil(orders.length / state.rowsPerPage);
            if (page > totalPages) return;
            
            state.currentPage = page;
            renderOrdersTable();
        }
        
        function renderStatisticsCards() {
    const container = document.getElementById('statisticsCards');
    
    // นับออเดอร์ที่ยังไม่ได้วางแผน
    const unplannedOrders = orders.filter(o => o.status === 'รอวางแผน').length;
    
    const stats = [
        { title: 'จำนวนทริปทั้งหมด', value: trips.length, color: 'green', icon: '🚛' },
        { title: 'การใช้ประโยชน์เฉลี่ย', value: trips.length > 0 ? (trips.reduce((sum, trip) => sum + trip.utilization, 0) / trips.length).toFixed(1) + '%' : '0%', color: 'blue', icon: '📊' },
        { title: 'CBM รวม', value: trips.reduce((sum, trip) => sum + trip.cbm, 0).toFixed(1), color: 'orange', icon: '📦' },
        { title: 'ระยะทางรวม (กม.)', value: trips.reduce((sum, trip) => sum + trip.distance, 0).toFixed(1), color: 'purple', icon: '📍' },
        { title: 'สาขารวม', value: trips.reduce((sum, trip) => sum + trip.branches, 0), color: 'yellow', icon: '🏪' },
        { title: 'น้ำหนักรวม (ตัน)', value: (trips.reduce((sum, trip) => sum + trip.weight, 0) / 1000).toFixed(1), color: 'indigo', icon: '⚖️' },
        { title: 'ออเดอร์รอวางแผน', value: unplannedOrders, color: unplannedOrders > 0 ? 'red' : 'green', icon: unplannedOrders > 0 ? '⚠️' : '✅' }
    ];
    
    container.innerHTML = stats.map(stat => `
        <div class="bg-gradient-to-br from-${stat.color}-50 to-${stat.color}-100 rounded-xl p-4 border border-${stat.color}-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">${stat.title}</p>
                    <p class="text-2xl font-bold text-${stat.color}-700 mt-1">${stat.value}</p>
                </div>
                <span class="text-3xl">${stat.icon}</span>
            </div>
        </div>
    `).join('');
}
        
        function renderTripCards() {
            const container = document.getElementById('tripCardsContainer');
            container.innerHTML = trips.map((trip, index) => createTripCardHTML(trip, index)).join('');
            
            // Initialize driver search after rendering
            setTimeout(() => {
                initializeDriverSearch();
            }, 100);
        }
        
        function createTripCardHTML(trip, index) {
            const isDropTarget = state.selectedForDrag && state.selectedForDrag.fromTripId !== trip.id;
            const color = state.tripColors[index % state.tripColors.length];
            const utilizationColor = trip.utilization >= 90 ? '#03A477' : trip.utilization >= 70 ? '#FFA726' : '#EF5350';
            
            return `
                <div id="trip-${trip.id}" 
     class="trip-card ${isDropTarget ? 'drop-target' : ''}"
     draggable="true"
     ondragstart="dragStart(event, '${trip.id}')"
     ondrop="dropTrip(event, '${trip.id}')"
     ondragover="allowDrop(event)"
                     onclick="${isDropTarget ? `handleTripClickDrop('${trip.id}')` : ''}"
                     style="border-color: ${color};">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2 flex-1">
                            <div class="bg-gray-900 text-white px-2 py-1 rounded text-sm font-bold">
                                ${trip.id}
                            </div>
                            <div class="bg-gray-100 px-2 py-1 rounded text-xs font-medium">
                                ${trip.type}
                            </div>
                            ${trip.driver ? `
                                <div class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium flex items-center gap-1">
                                    👤 ${trip.driver}
                                </div>
                            ` : ''}
                            ${isDropTarget ? `
                                <div class="px-2 py-1 rounded text-xs font-medium animate-bounce bg-orange-100 text-orange-700">
                                    🖱️ คลิกเพื่อย้าย
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="trip-stats-grid">
                        <div class="trip-stat bg-green-50">
                            <p class="trip-stat-value text-green-600">${trip.branches}</p>
                            <p class="trip-stat-label">สาขา</p>
                        </div>
                        <div class="trip-stat bg-blue-50">
                            <p class="trip-stat-value text-blue-600">${Math.round(trip.weight).toLocaleString()}</p>
                            <p class="trip-stat-label">kg</p>
                        </div>
                        <div class="trip-stat bg-purple-50">
                            <p class="trip-stat-value text-purple-600">${Math.round(trip.utilization)}%</p>
                            <p class="trip-stat-label">ใช้ประโยชน์</p>
                        </div>
                        <div class="trip-stat bg-orange-50">
                            <p class="trip-stat-value text-orange-600">${trip.cbm.toFixed(1)}</p>
                            <p class="trip-stat-label">CBM</p>
                        </div>
                        <div class="trip-stat bg-indigo-50">
                            <p class="trip-stat-value text-indigo-600">${Math.round(trip.distance)}</p>
                            <p class="trip-stat-label">กม.</p>
                        </div>
                    </div>
                    
                    <div class="progress-bar mt-3">
                        <div class="progress-bar-fill" style="width: ${trip.utilization}%; background-color: ${utilizationColor};"></div>
                    </div>
                    
                    ${!trip.driver ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-3">
                            <label class="text-xs font-medium text-yellow-800 mb-1 block">กำหนดคนขับ:</label>
                            <div class="driver-search-container">
                                <input type="text" 
                                       placeholder="พิมพ์ชื่อคนขับ..." 
                                       class="driver-search-input" 
                                       data-trip-id="${trip.id}">
                                <div class="driver-search-dropdown hidden" id="driverDropdown-${trip.id}">
                                    ${drivers.filter(d => 
                                        d.vehicleTypes.some(vt => vt === trip.type || vt.includes(trip.type))
                                    ).map(driver => 
                                        `<div class="driver-search-item" onclick="selectDriver('${trip.id}', '${driver.id}')">
                                            ${driver.name} - ${driver.phone}
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-medium text-green-800">คนขับที่กำหนด:</p>
                                    <p class="text-sm font-bold text-green-700">👤 ${trip.driver}</p>
                                </div>
                                <button onclick="changeDriver('${trip.id}')" class="text-xs text-green-600 hover:text-green-700 hover:underline">
                                    เปลี่ยนคนขับ
                                </button>
                            </div>
                        </div>
                    `}
                    
                    <div class="mt-3 border-t pt-3">
                        <p class="text-xs font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="text-gray-400">⠿</span>
                            สาขาในทริป (ลากเพื่อเรียงลำดับ):
                        </p>
                        <div class="branch-list-container">
                            ${trip.branchList.map((branch, idx) => createBranchHTML(branch, trip.id, idx)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createBranchHTML(branch, tripId, idx) {
    const isSelected = state.selectedForDrag && 
                     state.selectedForDrag.branch.name === branch.name && 
                     state.selectedForDrag.fromTripId === tripId;
    
    // ใช้ backticks ` ไม่ใช่ quotes '
    return `
        <div id="branch-${tripId}-${idx}" 
             class="branch-item ${isSelected ? 'selected' : ''}">
            <div class="flex items-start gap-2">
                <div class="flex-shrink-0">
                    <span class="bg-blue-100 text-blue-700 text-xs font-bold px-1.5 py-0.5 rounded">
                        #${idx + 1}
                    </span>
                </div>
                <div class="flex-1">
                    <p class="text-xs font-medium text-gray-800">${branch.name}</p>
                    <div class="flex justify-between text-xs text-gray-600 mt-1">
                        <span>⚖️ ${branch.weight ? branch.weight.toLocaleString() : 0} kg</span>
                        <span class="text-orange-600">📦 ${branch.cbm || 0} CBM</span>
                    </div>
                    ${branch.windowTime ? `
                        <div class="text-xs text-gray-500 mt-1">
                            ⏰ ${branch.windowTime}
                        </div>
                    ` : ''}
                </div>
                <div class="flex-shrink-0 flex gap-1">
                    <button type="button" 
                            class="p-1 text-blue-600 hover:text-blue-700 hover:bg-blue-100 rounded transition-all"
                            onclick="openMoveBranchModal('${branch.name.replace(/'/g, "\\'")}', '${tripId}')"
                            title="ย้ายสาขา">
                        🔄
                    </button>
                    <button type="button"
                            class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded transition-all"
                            onclick="removeBranch('${tripId}', ${idx})"
                            title="ลบสาขา">
                        ❌
                    </button>
                </div>
            </div>
        </div>
    `;
}
      // เพิ่มตรงท้ายสุดของ JavaScript
window.openMoveBranchModal = openMoveBranchModal;
        
        function renderVehicleTypesTable() {
            const tbody = document.getElementById('vehicleTypesTableBody');
            tbody.innerHTML = vehicleTypes.map(vehicle => `
                <tr>
                    <td>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${vehicle.icon}</span>
                            <span class="text-sm font-medium text-gray-900">${vehicle.code}</span>
                        </div>
                    </td>
                    <td>${vehicle.name}</td>
                    <td>
                        <span class="badge badge-gray">${vehicle.category}</span>
                    </td>
                    <td>${vehicle.maxWeight.toLocaleString()}</td>
                    <td>${vehicle.maxCBM}</td>
                    <td>${vehicle.maxDestinations}</td>
                    <td>${vehicle.maxDistance ? vehicle.maxDistance.toLocaleString() : '-'}</td>
                    <td>฿${vehicle.costPerKm}</td>
                    <td class="text-right">
    <button onclick="editVehicle('${vehicle.id}')" class="text-teal-600 hover:text-teal-700 mr-3" style="color: #20B2AA;">
        ✏️
    </button>
    <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-600 hover:text-red-700">
        🗑️
    </button>
</td>
                </tr>
            `).join('');
        }
        
        function renderDriversGrid() {
            const container = document.getElementById('driversGrid');
            container.innerHTML = drivers.map(driver => `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all">
                    <div class="bg-gradient-to-r from-teal-500 to-cyan-500 p-4 text-white" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white rounded-full overflow-hidden">
                                <div class="w-full h-full flex items-center justify-center bg-gray-100">
                                    👤
                                </div>
                            </div>
                            <div class="text-white">
                                <h3 class="font-bold text-lg">${driver.name}</h3>
                                <p class="text-sm" style="opacity: 0.9;">${driver.id}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">📞</span>
                                <span class="text-sm text-gray-700">${driver.phone}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">💳</span>
                                <span class="text-sm text-gray-700">ใบขับขี่: ${driver.licenseNo}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">📅</span>
                                <span class="text-sm text-gray-700">หมดอายุ: ${driver.licenseExpiry}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">🚛</span>
                                <div class="flex flex-wrap gap-1">
                                    ${driver.vehicleTypes.map(type => `
                                        <span class="badge badge-blue">${type}</span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">📍</span>
                                <span class="text-sm text-gray-700">${driver.area}</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-600">${driver.company}</p>
                        </div>
                    </div>
                    <div class="px-4 pb-4 flex gap-2">
    <button onclick="editDriver('${driver.id}')" class="flex-1 btn btn-primary text-sm">
        แก้ไข
    </button>
    <button onclick="deleteDriver('${driver.id}')" class="btn btn-danger text-sm">
        ลบ
    </button>
</div>
                </div>
            `).join('');
        }
        
        function renderHistoryGrid(filterDate = null) {
            const container = document.getElementById('historyGrid');
            
            let filteredHistory = deliveryHistory;
            if (filterDate) {
                filteredHistory = deliveryHistory.filter(h => h.date === filterDate);
            }
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8 text-gray-500">
                        <svg class="icon-xl mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>ไม่พบประวัติการจัดส่ง</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredHistory.map(history => `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all cursor-pointer group">
                    <div class="bg-gradient-to-r from-teal-500 to-cyan-500 p-4 text-white" style="--gradient-from: #20B2AA; --gradient-to: #48D1CC;">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">📅</span>
                                <h3 class="font-bold text-lg">${new Date(history.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                            </div>
                            <span>✓</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-teal-600" style="color: #20B2AA;">${history.trips}</p>
                                <p class="text-sm text-gray-600">ทริป</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-orange-600">${history.orders}</p>
                                <p class="text-sm text-gray-600">ออเดอร์</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-blue-600">${history.totalWeight.toLocaleString()}</p>
                                <p class="text-sm text-gray-600">น้ำหนัก (kg)</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-bold text-purple-600">${history.totalCBM.toFixed(1)}</p>
                                <p class="text-sm text-gray-600">CBM</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewHistoryDetails('${history.id}')" class="flex-1 btn btn-secondary text-sm">
                                👁️ ดูรายละเอียด
                            </button>
                            <button onclick="exportHistoryPlan('${history.id}')" class="btn btn-secondary text-sm">
                                📥 Export
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function viewHistoryDetails(historyId) {
            const history = deliveryHistory.find(h => h.id === historyId);
            if (!history || !history.tripDetails) {
                showNotification('ไม่พบข้อมูลรายละเอียด', 'error');
                return;
            }
            
            // Create modal content
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">รายละเอียดการจัดส่ง</h3>
                            <button onclick="closeHistoryDetailsModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-lg font-semibold">วันที่: ${new Date(history.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <div class="grid grid-cols-4 gap-4 mt-4">
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-xl font-bold text-gray-800">${history.trips}</p>
                                    <p class="text-sm text-gray-600">ทริปทั้งหมด</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-xl font-bold text-gray-800">${history.orders}</p>
                                    <p class="text-sm text-gray-600">ออเดอร์</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-xl font-bold text-gray-800">${history.totalWeight.toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">น้ำหนัก (kg)</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-xl font-bold text-gray-800">${history.totalCBM.toFixed(1)}</p>
                                    <p class="text-sm text-gray-600">CBM รวม</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            ${history.tripDetails.map(trip => `
                                <div class="border rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="font-semibold text-lg">${trip.id}</h4>
                                            <p class="text-sm text-gray-600">
                                                ${trip.type} • ${trip.driver || 'ไม่ระบุคนขับ'} • ${trip.branches} สาขา
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-600">ระยะทาง: ${trip.distance} กม.</p>
                                            <p class="text-sm text-gray-600">CBM: ${trip.cbm.toFixed(1)}</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        ${trip.branchList.map((branch, idx) => `
                                            <div class="bg-gray-50 rounded p-2 text-sm">
                                                <span class="font-medium">${idx + 1}. ${branch.name}</span>
                                                <span class="text-gray-500 ml-2">
                                                    (${branch.weight.toLocaleString()} kg, ${branch.cbm} CBM)
                                                </span>
                                                ${branch.windowTime ? `<span class="text-gray-500 ml-2">⏰ ${branch.windowTime}</span>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-6 flex gap-3">
                            <button onclick="exportHistoryPlan('${history.id}')" class="btn btn-primary">
                                📥 Export ข้อมูลทั้งหมด
                            </button>
                            <button onclick="closeHistoryDetailsModal()" 
    class="w-full btn btn-primary">
    ปิด
</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            const modalDiv = document.createElement('div');
            modalDiv.id = 'historyDetailsModal';
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);
        }
        
        function closeHistoryDetailsModal() {
            const modal = document.getElementById('historyDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function exportHistoryPlan(historyId) {
            const history = deliveryHistory.find(h => h.id === historyId);
            if (!history || !history.tripDetails) {
                showNotification('ไม่พบข้อมูลสำหรับ Export', 'error');
                return;
            }
            
            const headers = ['วันที่', 'Trip Number', 'Store', 'Store ID', 'Store Address', 'Driver Name', 'Truck Type', 'Distance (km)', 'CBM', 'Weight (kg)', 'Window Time'];
            let csvContent = headers.join(',') + '\n';
            
            history.tripDetails.forEach(trip => {
                trip.branchList.forEach((branch, index) => {
                    const row = [
                        history.date,
                        trip.id,
                        branch.name,
                        `ST${String(index + 1).padStart(3, '0')}`,
                        (branch.address || '').replace(/,/g, ';'),
                        trip.driver || 'N/A',
                        trip.type,
                        Math.round((trip.distance || 0) / trip.branches), // Average distance per branch
                        branch.cbm,
                        branch.weight,
                        branch.windowTime || ''
                    ];
                    csvContent += row.join(',') + '\n';
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `delivery_history_${history.date}_${historyId}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Export แผนการจัดส่งวันที่ ${new Date(history.date).toLocaleDateString('th-TH')} สำเร็จ!`, 'success');
        }
        
        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            container.innerHTML = notifications.map(notif => {
                const colorClass = notif.type === 'new' ? 'bg-blue-500' : 
                                 notif.type === 'update' ? 'bg-yellow-500' : 'bg-green-500';
                
                return `
                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <div class="flex items-start gap-3">
                            <div class="${colorClass} w-3 h-3 rounded-full mt-1.5"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${notif.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${notif.time}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
       function updateVehicleTypeFilter() {
    const select = document.getElementById('vehicleTypeFilter');
    if (!select) return;
    
    const currentValue = select.value;
    
    // รวบรวมประเภทรถจากทริปที่มีอยู่
    const vehicleTypesInTrips = [...new Set(trips.map(t => t.type))];
    
    // สร้าง options
    select.innerHTML = '<option value="">ทุกประเภทรถ</option>';
    
    vehicleTypesInTrips.forEach(type => {
        let displayName = type;
        // เพิ่ม emoji สำหรับรถพิเศษ
        if (type.includes('COOL')) {
            displayName = '❄️ ' + type;
        } else if (type === 'OIL') {
            displayName = '⛽ ' + type;
        }
        
        const option = document.createElement('option');
        option.value = type;
        option.textContent = displayName;
        select.appendChild(option);
    });
    
    // คืนค่าที่เลือกไว้
    select.value = currentValue || '';
}
        
        // Form Submissions
        document.getElementById('addVehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newVehicle = {
                id: `VH${String(vehicleTypes.length + 1).padStart(3, '0')}`,
                code: formData.get('code'),
                name: formData.get('name'),
                maxWeight: parseInt(formData.get('maxWeight')),
                maxCBM: parseInt(formData.get('maxCBM')),
                maxDestinations: parseInt(formData.get('maxDestinations')),
                maxDistance: parseInt(formData.get('maxDistance')),
                category: state.selectedVehicleCategory,
                costPerKm: parseFloat(formData.get('costPerKm')),
                icon: vehicleCategories.find(c => c.name === state.selectedVehicleCategory)?.icon || '🚛'
            };
            
            vehicleTypes.push(newVehicle);
            saveToStorage('driver_adz_vehicles', vehicleTypes);
            hideAddVehicleForm();
            showNotification('เพิ่มประเภทรถใหม่เรียบร้อยแล้ว', 'success');
            renderVehicleTypesTable();
            updateVehicleTypeFilter();
        });
        
        document.getElementById('addDriverForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const vehicleTypes = [];
            document.querySelectorAll('input[name="vehicleTypes"]:checked').forEach(checkbox => {
                vehicleTypes.push(checkbox.value);
            });
            
            const newDriver = {
                id: `DRV${String(drivers.length + 1).padStart(3, '0')}`,
                name: formData.get('name'),
                phone: formData.get('phone'),
                licenseType: formData.get('licenseType'),
                licenseNo: formData.get('licenseNo'),
                licenseExpiry: formData.get('licenseExpiry'),
                vehicleTypes: vehicleTypes,
                area: formData.get('area'),
                company: formData.get('company'),
                photo: null,
                startDate: formData.get('startDate')
            };
            
            drivers.push(newDriver);
            saveToStorage('driver_adz_drivers', drivers);
            hideAddDriverForm();
            showNotification('เพิ่มข้อมูลคนขับใหม่เรียบร้อยแล้ว', 'success');
            renderDriversGrid();
        });
        
        // Click outside to close notifications
        document.addEventListener('click', function(e) {
            const notifButton = e.target.closest('button[onclick="toggleNotifications()"]');
            const notifDropdown = document.getElementById('notificationsDropdown');
            
            if (!notifButton && !notifDropdown.contains(e.target) && state.showNotifications) {
                state.showNotifications = false;
                notifDropdown.classList.add('hidden');
            }
            
            // Close map popup when clicking outside
            const mapPopup = document.getElementById('mapBranchPopup');
            if (mapPopup && !mapPopup.contains(e.target) && !e.target.closest('.gm-style')) {
                closeMapPopup();
            }
        });
        
        // Initialize demo data
        function initializeDemoData() {
            const demoOrders = [
                {
                    id: 'ORD0001',
                    branchCode: 'BR001',
                    branch: 'สาขาลาดพร้าว',
                    address: '123 ถ.ลาดพร้าว แขวงลาดพร้าว เขตลาดพร้าว กรุงเทพฯ 10230',
                    lat: 13.8166,
                    lng: 100.5745,
                    cbm: 5.2,
                    weight: 1200,
                    pieces: 50,
                    workDate: '2024-01-20',
                    openTime: '08:00',
                    closeTime: '18:00',
                    unloadTime: '30',
                    vehicleType: 'สินค้าทั่วไป',
                    contactName: 'คุณสมชาย',
                    contactPhone: '081-234-5678',
                    location: 'หน้าร้าน',
                    status: 'รอวางแผน'
                },
                {
                    id: 'ORD0002',
                    branchCode: 'BR002',
                    branch: 'สาขารามอินทรา',
                    address: '456 ถ.รามอินทรา แขวงอนุสาวรีย์ เขตบางเขน กรุงเทพฯ 10220',
                    lat: 13.8668,
                    lng: 100.6045,
                    cbm: 3.8,
                    weight: 850,
                    pieces: 35,
                    workDate: '2024-01-20',
                    openTime: '09:00',
                    closeTime: '19:00',
                    unloadTime: '25',
                    vehicleType: 'สินค้าทั่วไป',
                    contactName: 'คุณสมหญิง',
                    contactPhone: '082-345-6789',
                    location: 'ลานจอดหลังอาคาร',
                    status: 'รอวางแผน'
                },
                {
                    id: 'ORD0003',
                    branchCode: 'BR003',
                    branch: 'สาขาพระราม 9',
                    address: '789 ถ.พระราม 9 แขวงห้วยขวาง เขตห้วยขวาง กรุงเทพฯ 10310',
                    lat: 13.7593,
                    lng: 100.5699,
                    cbm: 6.5,
                    weight: 1500,
                    pieces: 60,
                    workDate: '2024-01-20',
                    openTime: '08:30',
                    closeTime: '17:30',
                    unloadTime: '35',
                    vehicleType: 'สินค้าควบคุมอุณหภูมิ',
                    contactName: 'คุณสมศักดิ์',
                    contactPhone: '083-456-7890',
                    location: 'ท่าขนของ',
                    status: 'รอวางแผน'
                }
            ];
            
            const demoVehicleTypes = [
                {
                    id: 'VH001',
                    code: '4W',
                    name: 'รถบรรทุก 4 ล้อ',
                    category: 'รถบรรทุก 4 ล้อ',
                    maxWeight: 2000,
                    maxCBM: 10,
                    maxDestinations: 8,
                    maxDistance: 200,
                    costPerKm: 12.5,
                    icon: '🚛'
                },
                {
                    id: 'VH002',
                    code: '6W',
                    name: 'รถบรรทุก 6 ล้อ',
                    category: 'รถบรรทุก 6 ล้อ',
                    maxWeight: 5000,
                    maxCBM: 20,
                    maxDestinations: 12,
                    maxDistance: 300,
                    costPerKm: 18.5,
                    icon: '🚚'
                },
                {
                    id: 'VH003',
                    code: '10W',
                    name: 'รถบรรทุก 10 ล้อ',
                    category: 'รถบรรทุก 10 ล้อ',
                    maxWeight: 10000,
                    maxCBM: 40,
                    maxDestinations: 15,
                    maxDistance: 500,
                    costPerKm: 25.0,
                    icon: '🚛'
                },
                {
                    id: 'VH004',
                    code: 'COOL',
                    name: 'รถห้องเย็น',
                    category: 'รถควบคุมอุณหภูมิ',
                    maxWeight: 3000,
                    maxCBM: 15,
                    maxDestinations: 10,
                    maxDistance: 250,
                    costPerKm: 22.0,
                    icon: '❄️'
                }
            ];
            
            const demoDrivers = [
                {
                    id: 'DRV001',
                    name: 'สมชาย ใจดี',
                    phone: '081-111-2222',
                    licenseType: 'ท.2',
                    licenseNo: 'ท.21/12345',
                    licenseExpiry: '2025-12-31',
                    vehicleTypes: ['4W', '6W'],
                    area: 'กรุงเทพฯ',
                    company: 'ABC Logistics',
                    photo: null
                },
                {
                    id: 'DRV002',
                    name: 'สมหญิง รักงาน',
                    phone: '082-222-3333',
                    licenseType: 'ท.3',
                    licenseNo: 'ท.31/67890',
                    licenseExpiry: '2026-06-30',
                    vehicleTypes: ['6W', '10W', 'COOL'],
                    area: 'กรุงเทพฯ และปริมณฑล',
                    company: 'ABC Logistics',
                    photo: null
                }
            ];
            
            if (!loadFromStorage('driver_adz_orders') || loadFromStorage('driver_adz_orders').length === 0) {
                orders = demoOrders;
                saveToStorage('driver_adz_orders', orders);
            }
            
            if (!loadFromStorage('driver_adz_vehicles') || loadFromStorage('driver_adz_vehicles').length === 0) {
                vehicleTypes = demoVehicleTypes;
                saveToStorage('driver_adz_vehicles', vehicleTypes);
            }
            
            if (!loadFromStorage('driver_adz_drivers') || loadFromStorage('driver_adz_drivers').length === 0) {
                drivers = demoDrivers;
                saveToStorage('driver_adz_drivers', drivers);
            }
        }
        // ฟังก์ชันปิด Modal ทั่วไป
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
    }
}

// ฟังก์ชันปิด Modal แบบลบออกจาก DOM
function removeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            document.getElementById('historyDate').value = now.toISOString().substring(0, 10);
            
            initializeDemoData();
            loadPersistedData();
            switchTab('orders');
        });
      // ===== ฟังก์ชันสำหรับ Move Branch Modal =====
        
        // เปิด Modal ย้ายสาขา
        function openMoveBranchModal(branchName, fromTripId) {
    console.log('เปิด Modal ย้ายสาขา:', branchName, 'จากทริป:', fromTripId);
    
    const sourceTrip = trips.find(t => t.id === fromTripId);
    if (!sourceTrip) {
        console.error('ไม่พบทริป:', fromTripId);
        showNotification('ไม่พบข้อมูลทริป', 'error');
        return;
    }
    
    const branch = sourceTrip.branchList.find(b => b.name === branchName);
    if (!branch) {
        console.error('ไม่พบสาขา:', branchName);
        showNotification('ไม่พบข้อมูลสาขา', 'error');
        return;
    }
    
    // เก็บข้อมูลที่จะย้าย
    state.movingBranch = {
        branch: branch,
        fromTripId: fromTripId,
        sourceTrip: sourceTrip
    };
    
    // แสดงข้อมูลสาขาที่จะย้าย
    const branchInfoHTML = `
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-600">กำลังย้ายสาขา:</p>
                <p class="font-bold text-lg text-blue-700">${branch.name || 'ไม่ระบุชื่อ'}</p>
                <p class="text-sm text-gray-500 mt-1">
                    จากทริป: <span class="font-medium">${fromTripId} (${sourceTrip.type})</span>
                </p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-600">
                    <span class="block">⚖️ ${(branch.weight || 0).toLocaleString()} kg</span>
                    <span class="block text-orange-600">📦 ${branch.cbm || 0} CBM</span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('movingBranchInfo').innerHTML = branchInfoHTML;
    
    // แสดงรายการทริปที่สามารถย้ายไปได้
    renderTripOptions(fromTripId);
    
    // แสดง Modal
    const modal = document.getElementById('moveBranchModal');
    if (modal) {
        modal.classList.remove('hidden');
        
        // Focus ที่ช่องค้นหา
        setTimeout(() => {
            const searchInput = document.getElementById('tripSearchInput');
            if (searchInput) {
                searchInput.focus();
            }
        }, 100);
    } else {
        console.error('ไม่พบ Modal element');
        showNotification('ไม่พบหน้าต่างย้ายสาขา กรุณารีเฟรชหน้า', 'error');
    }
}
        // แสดงรายการทริปใน Modal
function renderTripOptions(fromTripId) {
    const container = document.getElementById('tripOptionsList');
    if (!container) return;
    
    const availableTrips = trips.filter(t => t.id !== fromTripId);
    
    // สร้างปุ่มสำหรับแต่ละทริป
    container.innerHTML = availableTrips.map(trip => {
        // คำนวณว่ารับได้หรือเต็ม
        const maxCBM = getMaxCBM(trip.type);
        const spaceLeft = maxCBM - trip.cbm;
        const canAccept = spaceLeft > 0;
        const statusText = canAccept ? 'รับได้' : 'เต็ม';
        const statusColor = canAccept ? 'text-green-600' : 'text-red-600';
        const bgColor = canAccept ? 'bg-green-50' : 'bg-red-50';
        
        return `
            <div class="trip-option-card" 
                 onclick="selectTargetTrip('${trip.id}')"
                 style="cursor: pointer;">
                <div class="flex justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 border-2 border-gray-200">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <strong class="text-lg">${trip.id}</strong>
                            <span class="text-sm text-gray-500">- ${trip.type}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">
                            ${trip.branches} สาขา | ${trip.cbm.toFixed(1)}/${maxCBM} CBM
                        </div>
                        ${canAccept ? 
                            `<div class="text-xs text-green-600 mt-1">
                                เหลือที่ว่าง ${spaceLeft.toFixed(1)} CBM
                            </div>` : 
                            `<div class="text-xs text-red-600 mt-1">
                                ⚠️ เต็มแล้ว (ใช้ไป 100%)
                            </div>`
                        }
                    </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${bgColor} ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
// ฟังก์ชันหา CBM สูงสุดของรถแต่ละประเภท
function getMaxCBM(vehicleType) {
    const capacities = {
        '4W': 10,
        '4WJ': 15,
        '6W': 20,
        '10W': 40,
        'COOL4W': 9,
        'COOL6W': 18,
        'OIL': 30,
        'TRAILER': 100,
        '6W-พิเศษ': 20
    };
    return capacities[vehicleType] || 20;
}

      // เลือกทริปปลายทาง
function selectTargetTrip(targetTripId) {
    console.log('=== selectTargetTrip ===');
    console.log('Selected trip:', targetTripId);
    
    if (!state.movingBranch) {
        console.error('❌ ไม่มีข้อมูลสาขาที่จะย้าย');
        showNotification('เกิดข้อผิดพลาด: ไม่มีข้อมูลสาขา', 'error');
        return;
    }
    
    const { branch, fromTripId } = state.movingBranch;
    const targetTrip = trips.find(t => t.id === targetTripId);
    
    if (!targetTrip) {
        console.error('❌ ไม่พบทริปปลายทาง');
        showNotification('เกิดข้อผิดพลาด: ไม่พบทริปปลายทาง', 'error');
        return;
    }
    
    // แสดง confirmation dialog
    const message = `
ยืนยันการย้ายสาขา?

📍 สาขา: ${branch.name}
📦 CBM: ${branch.cbm} | ⚖️ น้ำหนัก: ${(branch.weight || 0).toLocaleString()} kg

จาก: ${fromTripId}
ไปยัง: ${targetTripId} (${targetTrip.type})

ทริปปลายทางจะมี:
- ${targetTrip.branches + 1} สาขา
- ${(targetTrip.weight + (branch.weight || 0)).toLocaleString()} kg
- ${(targetTrip.cbm + (branch.cbm || 0)).toFixed(1)} CBM
`;
    
    if (confirm(message)) {
        console.log('✅ User confirmed');
        performBranchMove(branch, fromTripId, targetTripId);
    } else {
        console.log('❌ User cancelled');
    }
}

// ทำการย้ายสาขาจริง
function performBranchMove(branch, fromTripId, targetTripId) {
    console.log('=== performBranchMove ===');
    
    try {
        // เรียกฟังก์ชันย้ายที่มีอยู่แล้ว
        moveBranchBetweenTrips(branch, fromTripId, targetTripId);
        
        // ปิด Modal
        closeMoveBranchModal();
        
        // แสดงข้อความสำเร็จ
        showNotification(
            `✅ ย้าย ${branch.name} ไปยัง ${targetTripId} สำเร็จ!`, 
            'success'
        );
    } catch (error) {
        console.error('❌ Error during move:', error);
        showNotification(
            'เกิดข้อผิดพลาดในการย้าย: ' + error.message, 
            'error'
        );
    }
}
        
        // ตรวจสอบว่าทริปรับสาขาได้หรือไม่
        function checkIfTripCanAcceptBranch(trip, branch) {
            if (!branch) return false;
            
            // หาข้อมูลรถ
            const vehicleCapacities = {
                '4W': { maxCBM: 10, maxWeight: 2000, maxBranches: 8 },
                '4WJ': { maxCBM: 15, maxWeight: 3000, maxBranches: 10 },
                '6W': { maxCBM: 20, maxWeight: 5000, maxBranches: 12 },
                '10W': { maxCBM: 40, maxWeight: 10000, maxBranches: 15 },
                'COOL4W': { maxCBM: 9, maxWeight: 1800, maxBranches: 8 },
                'COOL6W': { maxCBM: 18, maxWeight: 4500, maxBranches: 10 },
                'OIL': { maxCBM: 30, maxWeight: 8000, maxBranches: 12 },
                'TRAILER': { maxCBM: 100, maxWeight: 25000, maxBranches: 20 },
                '6W-พิเศษ': { maxCBM: 20, maxWeight: 5000, maxBranches: 12 }
            };
            
            const capacity = vehicleCapacities[trip.type] || vehicleCapacities['6W'];
            
            // ตรวจสอบความจุ
            const newCBM = trip.cbm + branch.cbm;
            const newWeight = trip.weight + branch.weight;
            const newBranches = trip.branches + 1;
            
            return newCBM <= capacity.maxCBM && 
                   newWeight <= capacity.maxWeight && 
                   newBranches <= capacity.maxBranches;
        }
        
        // กรองทริปตามการค้นหา
        function filterTripOptions() {
            const searchTerm = document.getElementById('tripSearchInput').value.toLowerCase();
            const tripOptions = document.querySelectorAll('.trip-option');
            
            tripOptions.forEach(option => {
                const tripId = option.dataset.tripId.toLowerCase();
                const tripType = option.dataset.tripType.toLowerCase();
                
                if (tripId.includes(searchTerm) || tripType.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
      // ยืนยันการย้าย
function confirmMoveBranch(targetTripId) {
    console.log('=== เริ่ม confirmMoveBranch ===');
    console.log('Target Trip ID:', targetTripId);
    console.log('Moving Branch State:', state.movingBranch);
    
    if (!state.movingBranch) {
        console.error('❌ ไม่มีข้อมูลสาขาที่จะย้าย');
        showNotification('ไม่มีข้อมูลสาขาที่จะย้าย', 'error');
        return;
    }
    
    const { branch, fromTripId } = state.movingBranch;
    
    // ตรวจสอบข้อมูล
    console.log('Branch to move:', branch);
    console.log('From Trip:', fromTripId);
    console.log('To Trip:', targetTripId);
    
    // แสดง confirmation
    const confirmMessage = `ยืนยันการย้าย "${branch.name}"\n\nจาก: ${fromTripId}\nไปยัง: ${targetTripId}`;
    
    if (confirm(confirmMessage)) {
        console.log('✅ ผู้ใช้ยืนยันการย้าย');
        
        try {
            // ทำการย้าย
            moveBranchBetweenTrips(branch, fromTripId, targetTripId);
            
            // ปิด Modal
            closeMoveBranchModal();
            
            console.log('✅ ย้ายเสร็จสิ้น');
        } catch (error) {
            console.error('❌ Error:', error);
            showNotification('เกิดข้อผิดพลาดในการย้าย: ' + error.message, 'error');
        }
    } else {
        console.log('❌ ผู้ใช้ยกเลิกการย้าย');
    }
}
        
        /// ฟังก์ชันย้ายสาขาจริง
function moveBranchBetweenTrips(branch, fromTripId, targetTripId) {
    console.log('เริ่มย้ายสาขา:', branch.name);
    
    const sourceTrip = trips.find(t => t.id === fromTripId);
    const targetTrip = trips.find(t => t.id === targetTripId);
    
    if (!sourceTrip || !targetTrip) {
        console.error('ไม่พบทริปต้นทางหรือปลายทาง');
        showNotification('เกิดข้อผิดพลาด: ไม่พบข้อมูลทริป', 'error');
        return;
    }
    
    // ลบจากทริปต้นทาง
    const branchIndex = sourceTrip.branchList.findIndex(b => b.name === branch.name);
    if (branchIndex === -1) {
        console.error('ไม่พบสาขาในทริปต้นทาง');
        showNotification('เกิดข้อผิดพลาด: ไม่พบสาขาในทริป', 'error');
        return;
    }
    
    // ลบสาขาจากทริปต้นทาง
    sourceTrip.branchList.splice(branchIndex, 1);
    sourceTrip.branches = sourceTrip.branchList.length;
    sourceTrip.weight = sourceTrip.branchList.reduce((sum, b) => sum + (b.weight || 0), 0);
    sourceTrip.cbm = sourceTrip.branchList.reduce((sum, b) => sum + (b.cbm || 0), 0);
    
    // อัพเดท utilization ของทริปต้นทาง
    const vehicleCapacities = {
        '4W': { maxCBM: 10 },
        '4WJ': { maxCBM: 15 },
        '6W': { maxCBM: 20 },
        '10W': { maxCBM: 40 },
        'COOL4W': { maxCBM: 9 },
        'COOL6W': { maxCBM: 18 },
        'OIL': { maxCBM: 30 },
        'TRAILER': { maxCBM: 100 },
        '6W-พิเศษ': { maxCBM: 20 }
    };
    
    const sourceCapacity = vehicleCapacities[sourceTrip.type] || vehicleCapacities['6W'];
    sourceTrip.utilization = sourceTrip.branches > 0 
        ? Math.round((sourceTrip.cbm / sourceCapacity.maxCBM) * 100)
        : 0;
    
    // อัพเดท locations ของทริปต้นทาง
    if (sourceTrip.locations) {
        sourceTrip.locations = sourceTrip.locations.filter(loc => loc.name !== branch.name);
    }
    
    // ลบทริปถ้าว่างเปล่า
    if (sourceTrip.branches === 0) {
        const sourceTripIndex = trips.findIndex(t => t.id === fromTripId);
        if (sourceTripIndex !== -1) {
            trips.splice(sourceTripIndex, 1);
            console.log('ลบทริปที่ว่างเปล่า:', fromTripId);
        }
    }
    
    // เพิ่มในทริปปลายทาง
    targetTrip.branchList.push(branch);
    targetTrip.branches = targetTrip.branchList.length;
    targetTrip.weight = targetTrip.branchList.reduce((sum, b) => sum + (b.weight || 0), 0);
    targetTrip.cbm = targetTrip.branchList.reduce((sum, b) => sum + (b.cbm || 0), 0);
    
    // อัพเดท utilization ของทริปปลายทาง
    const targetCapacity = vehicleCapacities[targetTrip.type] || vehicleCapacities['6W'];
    targetTrip.utilization = Math.round((targetTrip.cbm / targetCapacity.maxCBM) * 100);
    
    // เพิ่ม location ในทริปปลายทาง
    const branchOrder = orders.find(o => o.branch === branch.name);
    if (branchOrder && targetTrip.locations) {
        // เพิ่มก่อนจุดสุดท้าย (คลัง)
        const insertIndex = targetTrip.locations.length - 1;
        targetTrip.locations.splice(insertIndex, 0, {
            lat: branchOrder.lat,
            lng: branchOrder.lng,
            name: branch.name
        });
    }
    
    // บันทึกและอัพเดท
    persistTrips();
    renderTripCards();
    renderStatisticsCards();
    
    // อัพเดทแผนที่
    if (state.map) {
        drawOptimizedRoutes();
    }
    
    console.log('ย้ายสำเร็จ!');
    showNotification(
        `✅ ย้าย ${branch.name} จาก ${fromTripId} ไปยัง ${targetTripId} สำเร็จ!`, 
        'success'
    );
}
        
        // ปิด Modal
        function closeMoveBranchModal() {
            document.getElementById('moveBranchModal').classList.add('hidden');
            document.getElementById('tripSearchInput').value = '';
            state.movingBranch = null;
        }
        // Debug functions
window.debugMoveBranch = function() {
    console.log('=== Debug Move Branch ===');
    console.log('Trips:', trips);
    console.log('Moving Branch State:', state.movingBranch);
    console.log('Modal Element:', document.getElementById('moveBranchModal'));
    console.log('Trip Options Container:', document.getElementById('tripOptionsList'));
};

// Override confirmMoveBranch to add logging
const originalConfirmMoveBranch = window.confirmMoveBranch;
window.confirmMoveBranch = function(targetTripId) {
    console.log('>>> confirmMoveBranch called with:', targetTripId);
    if (originalConfirmMoveBranch) {
        originalConfirmMoveBranch(targetTripId);
    }
};
// Test onclick
window.testClick = function(tripId) {
    console.log('✅ คลิกทำงาน! Trip ID:', tripId);
    alert('คลิกทำงาน! กำลังย้ายไป ' + tripId);
}
// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global Error:', e.error);
    console.error('Stack:', e.error.stack);
});

// Make functions global
window.confirmMoveBranch = confirmMoveBranch;
window.moveBranchBetweenTrips = moveBranchBetweenTrips;
window.closeMoveBranchModal = closeMoveBranchModal;
// Make functions available globally
window.selectTargetTrip = selectTargetTrip;
window.performBranchMove = performBranchMove;
      // 🔴 ทำให้ฟังก์ชันใช้งานได้ทั่วทั้งหน้า
window.confirmMapMove = function(branchName, fromTripId, toTripId) {
    closeMapPopup();
    
    state.dropTarget = {
        branch: { name: branchName },
        fromTripId: fromTripId,
        targetTripId: toTripId
    };
    
    // หา branch data จริง
    const sourceTrip = trips.find(t => t.id === fromTripId);
    if (sourceTrip) {
        const branch = sourceTrip.branchList.find(b => b.name === branchName);
        if (branch) {
            state.dropTarget.branch = branch;
        }
    }
    
    showDropConfirmModal();
};

// 🔴 ปิด popup เมื่อกด ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const popup = document.getElementById('mapBranchPopup');
        if (popup && !popup.classList.contains('hidden')) {
            closeMapPopup();
        }
    }
});
    </script>
</body>
</html>
   
